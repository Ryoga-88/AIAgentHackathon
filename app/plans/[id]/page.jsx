"use client";
import { useState, useEffect, use } from "react";
import { useRouter } from "next/navigation";
import {
  getLocationData,
  extractLocationsFromPlan,
  getMultipleLocationsData,
  enrichPlanWithLocationData,
} from "../../../utils/locationUtils";
import InteractiveMap from "../../../components/InteractiveMap";
import { useAuth } from "../../../contexts/AuthContext";
import { usePlanData } from "../../../contexts/PlanDataContext";
import UserProfile from "../../../components/Auth/UserProfile";
import BlurredContent from "../../../components/BlurredContent";
import ProgressModalDynamic from "../../../components/ProgressModalDynamic";
import { db } from "../../../lib/firebase";
import { doc, getDoc } from "firebase/firestore";

export default function PlansPage({ params }) {
  const router = useRouter();
  const { currentUser, loading: authLoading } = useAuth();
  const { planData, isDirectTransition, clearPlanData } = usePlanData();

  // Next.js 15ÂØæÂøú: params„ÇíÊ≠£„Åó„ÅèËß£Ê±∫
  const resolvedParams = use(params);
  const planId = resolvedParams?.id;
  console.log("üé® URL„Éë„É©„É°„Éº„Çø planId:", planId);
  const [selectedPlan, setSelectedPlan] = useState(null);
  const [expandedDay, setExpandedDay] = useState(null);
  const [plans, setPlans] = useState([]);
  const [loading, setLoading] = useState(true);
  const [hotels, setHotels] = useState({});
  const [locationData, setLocationData] = useState({});
  const [activityImages, setActivityImages] = useState({});
  const [heroImages, setHeroImages] = useState({});
  const [dayImages, setDayImages] = useState({});
  const [routeData, setRouteData] = useState({});
  const [showLoginPrompt, setShowLoginPrompt] = useState(false);
  const [hasStoredPlans, setHasStoredPlans] = useState(false);
  const [isClient, setIsClient] = useState(false);
  const [showDatePicker, setShowDatePicker] = useState(false);
  const [startDate, setStartDate] = useState("");
  const [endDate, setEndDate] = useState("");
  const [showRegenerateForm, setShowRegenerateForm] = useState(false);
  const [additionalPrompt, setAdditionalPrompt] = useState("");
  const [people, setPeople] = useState(2);
  const [showCopySuccess, setShowCopySuccess] = useState(false);

  // ÈÄ≤Êçó„É¢„Éº„ÉÄ„É´Áî®„ÅÆÁä∂ÊÖã
  const [isRegenerating, setIsRegenerating] = useState(false);
  const [regenerationProgress, setRegenerationProgress] = useState(0);

  // ËøΩÂä†„Éá„Éº„ÇøÔºàÁîªÂÉè„Éª„Éû„ÉÉ„ÉóÁ≠âÔºâ„ÅÆË™≠„ÅøËæº„ÅøÁä∂ÊÖã
  const [additionalDataLoading, setAdditionalDataLoading] = useState(false);
  const [additionalDataProgress, setAdditionalDataProgress] = useState(0);

  // „ÇØ„É©„Ç§„Ç¢„É≥„Éà„Çµ„Ç§„Éâ„É¨„É≥„ÉÄ„É™„É≥„Ç∞„ÅÆÁ¢∫Ë™ç
  useEffect(() => {
    setIsClient(true);
  }, []);

  // „Éó„É©„É≥„Éá„Éº„Çø„ÇíÂèñÂæóÔºàÁõ¥Êé•ÈÅ∑Áßª„Åæ„Åü„ÅØFirestore„Åã„ÇâÔºâ
  useEffect(() => {
    console.log("üé® „Éó„É©„É≥Ë©≥Á¥∞„Éö„Éº„Ç∏ useEffectÈñãÂßã");
    console.log("üé® isClient:", isClient, "authLoading:", authLoading);
    console.log("üé® currentUser:", currentUser);
    console.log("üé® isDirectTransition:", isDirectTransition);
    console.log("üé® planData:", planData);
    console.log("üé® planId:", planId);
    console.log("üé® loading:", loading);

    if (!isClient || authLoading) {
      console.log("üé® „ÇØ„É©„Ç§„Ç¢„É≥„ÉàÊú™Ê∫ñÂÇô„Åæ„Åü„ÅØË™çË®ºË™≠„ÅøËæº„Åø‰∏≠„ÅÆ„Åü„ÇÅÂá¶ÁêÜ„Çí‰∏≠Ê≠¢");
      return; // Ë™çË®º„ÅÆË™≠„ÅøËæº„Åø‰∏≠„ÅØÂá¶ÁêÜ„Åó„Å™„ÅÑ
    }

    if (!planId) {
      console.log("üé® planID„ÅåÂèñÂæó„Åß„Åç„Åæ„Åõ„Çì");
      return; // planId„Åå„Å™„ÅÑÂ†¥Âêà„ÅØÂá¶ÁêÜ„Åó„Å™„ÅÑ
    }

    // „É≠„Ç∞„Ç§„É≥„É¶„Éº„Ç∂„Éº„Åã„Å©„ÅÜ„Åã„ÅßÂá¶ÁêÜ„ÇíÂàÜÂ≤êÔºà„É≠„Ç∞„Ç§„É≥‰∏çË¶Å„Åß„Ç¢„ÇØ„Çª„ÇπÂèØËÉΩÔºâ
    const isLoggedIn = !!currentUser;
    console.log("üé® „É≠„Ç∞„Ç§„É≥Áä∂ÊÖã:", isLoggedIn ? "„É≠„Ç∞„Ç§„É≥Ê∏à„Åø" : "Êú™„É≠„Ç∞„Ç§„É≥");

    const fetchPlans = async () => {
      try {
        // Áõ¥Êé•ÈÅ∑Áßª„ÅÆÂ†¥Âêà„ÅØContext„Åã„Çâ„Éá„Éº„Çø„Çí‰ΩøÁî®Ôºà„É≠„Ç∞„Ç§„É≥„É¶„Éº„Ç∂„Éº„ÅÆ„ÅøÔºâ
        if (isLoggedIn && isDirectTransition && planData) {
          console.log("üé® Áõ¥Êé•ÈÅ∑Áßª: Context„Åã„Çâ„Éó„É©„É≥„Éá„Éº„Çø„Çí‰ΩøÁî®", planData);
          console.log("üé® Áõ¥Êé•ÈÅ∑Áßª: „Éó„É©„É≥Êï∞", planData.plans?.length);
          setPlans(planData.plans);
          if (planData.travelDates) {
            setStartDate(planData.travelDates.startDate || "");
            setEndDate(planData.travelDates.endDate || "");
          }
          console.log("üé® Áõ¥Êé•ÈÅ∑Áßª: „É≠„Éº„Éá„Ç£„É≥„Ç∞ÁµÇ‰∫ÜË®≠ÂÆö");
          setLoading(false);
          // Áõ¥Êé•ÈÅ∑Áßª„ÅÆÂ†¥Âêà„ÅØContext„Çí„ÇØ„É™„Ç¢„Åó„Å™„ÅÑÔºàËøΩÂä†„Éá„Éº„ÇøÂèñÂæóÂæå„Å´„ÇØ„É™„Ç¢Ôºâ
          return;
        }

        // URL„Ç¢„ÇØ„Çª„Çπ„ÅÆÂ†¥Âêà„ÅØFirestore„Åã„ÇâÂèñÂæóÔºà„É≠„Ç∞„Ç§„É≥„ÉªÈùû„É≠„Ç∞„Ç§„É≥Âïè„Çè„ÅöÔºâ
        console.log("URL„Ç¢„ÇØ„Çª„Çπ: Firestore„Åã„Çâ„Éó„É©„É≥„ÇíÂèñÂæó‰∏≠...", planId);
        console.log(
          "üé® „Ç¢„ÇØ„Çª„ÇπÁ®ÆÂà•:",
          isLoggedIn ? "„É≠„Ç∞„Ç§„É≥„É¶„Éº„Ç∂„Éº" : "Èùû„É≠„Ç∞„Ç§„É≥„É¶„Éº„Ç∂„Éº"
        );

        if (!planId) {
          console.error("üé® „Éó„É©„É≥ID„ÅåÂèñÂæó„Åß„Åç„Åæ„Åõ„Çì");
          router.push("/");
          return;
        }

        // „Åæ„ÅöAPI„Ç®„É≥„Éâ„Éù„Ç§„É≥„ÉàÁµåÁî±„ÅßÂèñÂæó„ÇíË©¶Ë°å
        let firestorePlanData = null;
        try {
          const getResponse = await fetch(`/api/get-travel-plan?uid=${planId}`);
          const getResult = await getResponse.json();
          console.log("üé® APIÂèñÂæóÁµêÊûú:", getResult);

          if (getResponse.ok && !getResult.fallback) {
            firestorePlanData = getResult.data;
            console.log("üé® APIÁµåÁî±„ÅßÂèñÂæóÊàêÂäü!");
          } else {
            throw new Error("APIÂèñÂæóÂ§±Êïó„ÄÅÁõ¥Êé•ÂèñÂæó„Å´„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ");
          }
        } catch (apiError) {
          console.log(
            "üé® APIÂèñÂæóÂ§±Êïó„ÄÅÁõ¥Êé•FirestoreÂèñÂæó„ÇíË©¶Ë°å:",
            apiError.message
          );
          const planDocRef = doc(db, "travel_plans", planId);
          const planDocSnap = await getDoc(planDocRef);

          if (planDocSnap.exists()) {
            firestorePlanData = planDocSnap.data();
            console.log("üé® Áõ¥Êé•FirestoreÂèñÂæóÊàêÂäü:", firestorePlanData);
          }
        }

        if (firestorePlanData) {
          console.log("üé® ÂèñÂæó„Åó„Åü„Éó„É©„É≥„Éá„Éº„Çø:", firestorePlanData);

          // Êñ∞„Åó„ÅÑÂΩ¢ÂºèÔºàÊó•‰ªòÊÉÖÂ†±„ÇíÂê´„ÇÄÔºâ„ÅÆÂ†¥Âêà
          if (
            firestorePlanData.plans &&
            Array.isArray(firestorePlanData.plans)
          ) {
            console.log(
              "üé® Êñ∞ÂΩ¢Âºè„ÅÆ„Éó„É©„É≥„Éá„Éº„Çø„ÄÅ„Éó„É©„É≥Êï∞:",
              firestorePlanData.plans.length
            );
            setPlans(firestorePlanData.plans);
            // Êó•‰ªòÊÉÖÂ†±„ÅåÂê´„Åæ„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØÁä∂ÊÖã„Å´„Çª„ÉÉ„Éà
            if (
              firestorePlanData.travelDates ||
              firestorePlanData.travel_dates
            ) {
              const travelDates =
                firestorePlanData.travelDates || firestorePlanData.travel_dates;
              setStartDate(travelDates.startDate || "");
              setEndDate(travelDates.endDate || "");
            }
          } else if (Array.isArray(firestorePlanData)) {
            // Âè§„ÅÑÂΩ¢ÂºèÔºà„Éó„É©„É≥„ÅÆ„Åø„ÅÆÈÖçÂàóÔºâ„ÅÆÂ†¥Âêà
            console.log(
              "üé® Âè§ÂΩ¢Âºè„ÅÆ„Éó„É©„É≥„Éá„Éº„ÇøÔºàÈÖçÂàóÔºâ„ÄÅ„Éó„É©„É≥Êï∞:",
              firestorePlanData.length
            );
            setPlans(firestorePlanData);
          } else {
            // Âçò‰∏Ä„Éó„É©„É≥„ÅÆÂ†¥Âêà„ÅØÈÖçÂàó„Å´Â§âÊèõ
            console.log("üé® Âçò‰∏Ä„Éó„É©„É≥„Éá„Éº„Çø„ÇíÈÖçÂàó„Å´Â§âÊèõ");
            setPlans([firestorePlanData]);
          }
          console.log("üé® URL„Ç¢„ÇØ„Çª„Çπ: „É≠„Éº„Éá„Ç£„É≥„Ç∞ÁµÇ‰∫ÜË®≠ÂÆö");
          setLoading(false);
        } else {
          // Firestore„Å´„Éá„Éº„Çø„Åå„Å™„ÅÑÂ†¥Âêà„ÅØ„Éõ„Éº„É†„Éö„Éº„Ç∏„Å´„É™„ÉÄ„Ç§„É¨„ÇØ„Éà
          console.log(
            "üé® „Éó„É©„É≥„Éá„Éº„Çø„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÇ„Éõ„Éº„É†„Éö„Éº„Ç∏„Å´„É™„ÉÄ„Ç§„É¨„ÇØ„Éà„Åó„Åæ„Åô„ÄÇ"
          );
          router.push("/");
          return;
        }
      } catch (error) {
        console.error("üé® „Éó„É©„É≥„ÅÆÂèñÂæó„Å´Â§±Êïó:", error);
        // „Ç®„É©„ÉºÊôÇ„ÅØ„Éõ„Éº„É†„Éö„Éº„Ç∏„Å´„É™„ÉÄ„Ç§„É¨„ÇØ„Éà
        console.log("üé® „Ç®„É©„Éº: „É≠„Éº„Éá„Ç£„É≥„Ç∞ÁµÇ‰∫ÜË®≠ÂÆö");
        setLoading(false);
        router.push("/");
      }
    };

    fetchPlans();
  }, [
    isClient,
    currentUser,
    authLoading,
    router,
    isDirectTransition,
    planData,
    planId,
  ]); // ‰æùÂ≠òÈÖçÂàó„ÇíÈÅ©Âàá„Å´Ë®≠ÂÆö

  // ‰ΩçÁΩÆÊÉÖÂ†±„Å®„Éõ„ÉÜ„É´ÊÉÖÂ†±„ÇíÂèñÂæó
  useEffect(() => {
    if (plans.length === 0 || !isClient) return;

    const fetchData = async () => {
      // Áõ¥Êé•ÈÅ∑Áßª„ÅÆÂ†¥Âêà„ÅØÊÆµÈöéÁöÑ„Å´„Éá„Éº„ÇøÂèñÂæó
      if (isDirectTransition) {
        console.log("Áõ¥Êé•ÈÅ∑Áßª: ÊÆµÈöéÁöÑ„Éá„Éº„ÇøÂèñÂæó„ÇíÈñãÂßã");
        // Context„Åã„Çâ„ÅÆ„Éá„Éº„Çø„Çí‰ΩøÁî®Âæå„ÄÅËøΩÂä†„Éá„Éº„Çø„ÅÆÂèñÂæó„Çí1ÁßíÂæå„Å´ÈñãÂßã
        setTimeout(() => {
          fetchAdditionalData();
        }, 1000);
        return;
      }

      // URL„Ç¢„ÇØ„Çª„Çπ„ÅÆÂ†¥Âêà„ÅØÈÄöÂ∏∏„ÅÆÂá¶ÁêÜ
      fetchAdditionalData();
    };

    const fetchAdditionalData = async () => {
      try {
        // plans„ÅåÊúâÂäπ„Åß„ÅÇ„Çã„Åì„Å®„ÇíÁ¢∫Ë™ç
        if (!plans || !Array.isArray(plans) || plans.length === 0) {
          console.warn("„Éó„É©„É≥„Éá„Éº„Çø„ÅåÁÑ°Âäπ„Åß„Åô:", plans);
          setLoading(false);
          return;
        }

        console.log("üé® ËøΩÂä†„Éá„Éº„ÇøÂèñÂæóÈñãÂßãÔºàÁîªÂÉè„Éª„Éû„ÉÉ„Éó„Éª„Éõ„ÉÜ„É´Ôºâ");
        setAdditionalDataLoading(true);
        setAdditionalDataProgress(0);

        const mockPlans = plans;

        // ÂÖ®„Éó„É©„É≥„Åã„Çâ‰ΩçÁΩÆÊÉÖÂ†±„ÇíÊäΩÂá∫
        const allLocations = new Set();
        mockPlans.forEach((plan) => {
          const locations = extractLocationsFromPlan(plan);
          locations.forEach((loc) => allLocations.add(loc));
        });

        // ‰ΩçÁΩÆÊÉÖÂ†±„Çí‰∏ÄÊã¨ÂèñÂæó
        const locationsArray = Array.from(allLocations);
        console.log("ÂèñÂæó„Åô„Çã‰ΩçÁΩÆÊÉÖÂ†±:", locationsArray);
        setAdditionalDataProgress(10);

        let locationResults = {};
        try {
          locationResults = await getMultipleLocationsData(locationsArray);
          console.log("‰ΩçÁΩÆÊÉÖÂ†±ÂèñÂæóÁµêÊûú:", locationResults);
          setLocationData(locationResults);
          setAdditionalDataProgress(25);
        } catch (error) {
          console.error("‰ΩçÁΩÆÊÉÖÂ†±ÂèñÂæó„Å´Â§±Êïó:", error);
          // „Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Å¶„ÇÇ„Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥„ÇíÁ∂ôÁ∂ö
          setLocationData({});
          setAdditionalDataProgress(25);
        }

        // ÂêÑ„Éó„É©„É≥„ÅÆÊó•ÊØé„Å´„Éõ„ÉÜ„É´„ÇíÊ§úÁ¥¢ÔºàÊîπÂñÑÁâàÔºâ
        const hotelPromises = [];
        const hotelResults = {};

        for (const plan of plans.filter(
          (plan) => plan && plan.itinerary && Array.isArray(plan.itinerary)
        )) {
          hotelResults[plan.trip_id] = {};

          for (const day of plan.itinerary) {
            // ÊúÄÁµÇÊó•‰ª•Â§ñ„ÅÆÊó•„Åß„Éõ„ÉÜ„É´Ê§úÁ¥¢
            if (
              day.accommodation &&
              day.accommodation !== "Âá∫Áô∫Êó•„ÅÆ„Åü„ÇÅÂÆøÊ≥ä„Å™„Åó"
            ) {
              const accommodationLocation = day.accommodation;
              const dayNumber = day.day;

              // „ÉÅ„Çß„ÉÉ„ÇØ„Ç§„É≥Êó•„Å®„ÉÅ„Çß„ÉÉ„ÇØ„Ç¢„Ç¶„ÉàÊó•„ÇíË®≠ÂÆö
              const today = new Date();
              const checkinDate = new Date(
                today.getTime() + (7 + dayNumber - 1) * 24 * 60 * 60 * 1000
              );
              const checkoutDate = new Date(
                checkinDate.getTime() + 24 * 60 * 60 * 1000
              );

              const checkinStr = checkinDate.toISOString().split("T")[0];
              const checkoutStr = checkoutDate.toISOString().split("T")[0];

              const promise = (async () => {
                try {
                  console.log(
                    `Day ${dayNumber} „Éõ„ÉÜ„É´Ê§úÁ¥¢: ${accommodationLocation}`,
                    {
                      checkin: checkinStr,
                      checkout: checkoutStr,
                    }
                  );

                  const hotelResponse = await fetch("/api/search-hotels", {
                    method: "POST",
                    headers: {
                      "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                      checkin: checkinStr,
                      checkout: checkoutStr,
                      adults: 2,
                      searchType: "location",
                      location: accommodationLocation,
                    }),
                  });

                  if (hotelResponse.ok) {
                    const hotelData = await hotelResponse.json();
                    console.log(`Day ${dayNumber} „Éõ„ÉÜ„É´Ê§úÁ¥¢ÊàêÂäü:`, hotelData);
                    return {
                      trip_id: plan.trip_id,
                      day: dayNumber,
                      results: hotelData.results || [],
                    };
                  } else {
                    console.error(
                      `Day ${dayNumber} „Éõ„ÉÜ„É´Ê§úÁ¥¢Â§±Êïó:`,
                      hotelResponse.status
                    );
                  }
                } catch (error) {
                  console.error(`Day ${dayNumber} „Éõ„ÉÜ„É´Ê§úÁ¥¢„Ç®„É©„Éº:`, error);
                }
                return { trip_id: plan.trip_id, day: dayNumber, results: [] };
              })();

              hotelPromises.push(promise);
            }
          }
        }

        // „Éõ„ÉÜ„É´ÊÉÖÂ†±„ÇíË®≠ÂÆöÔºàÊó•ÊØéÔºâ
        try {
          const hotelResponses = await Promise.all(hotelPromises);
          hotelResponses.forEach((response) => {
            if (!hotelResults[response.trip_id]) {
              hotelResults[response.trip_id] = {};
            }
            hotelResults[response.trip_id][`day_${response.day}`] =
              response.results;
          });
          console.log("Êó•ÊØé„Éõ„ÉÜ„É´Ê§úÁ¥¢ÁµêÊûú:", hotelResults);
          setHotels(hotelResults);
          setAdditionalDataProgress(50);
        } catch (error) {
          console.error("„Éõ„ÉÜ„É´ÊÉÖÂ†±ÂèñÂæó„Å´Â§±Êïó:", error);
          // „Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Å¶„ÇÇ„Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥„ÇíÁ∂ôÁ∂ö
          setHotels({});
          setAdditionalDataProgress(50);
        }

        // „Éó„É©„É≥„ÅÆ„Éí„Éº„É≠„ÉºÁîªÂÉè„Çí‰∏¶Ë°åÂèñÂæó
        const heroImagePromises = [];
        const heroImageResults = {};

        for (const plan of plans.filter((p) => p && p.hero && p.hero.title)) {
          console.log(
            `„Éí„Éº„É≠„ÉºÁîªÂÉèÂèñÂæóÈñãÂßã: ${plan.hero.title} (Trip: ${plan.trip_id})`
          );

          const promise = fetch("/api/places-photos", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              placeName: plan.hero.title,
            }),
          })
            .then(async (response) => {
              console.log(
                `„Éí„Éº„É≠„ÉºÁîªÂÉè„É¨„Çπ„Éù„É≥„Çπ (${plan.hero.title}):`,
                response.status
              );
              if (response.ok) {
                const imageData = await response.json();
                console.log(
                  `„Éí„Éº„É≠„ÉºÁîªÂÉèÂèñÂæóÊàêÂäü (${plan.hero.title}):`,
                  imageData
                );
                return {
                  trip_id: plan.trip_id,
                  data: imageData,
                };
              } else {
                const errorData = await response
                  .json()
                  .catch(() => ({ error: "‰∏çÊòé„Å™„Ç®„É©„Éº" }));
                console.warn(
                  `„Éí„Éº„É≠„ÉºÁîªÂÉèÂèñÂæóÂ§±Êïó (${plan.hero.title}):`,
                  response.status,
                  errorData
                );
              }
              return null;
            })
            .catch((error) => {
              console.error(
                `„Éí„Éº„É≠„ÉºÁîªÂÉèÂèñÂæó„Ç®„É©„Éº (${plan.hero.title}):`,
                error
              );
              return null;
            });

          heroImagePromises.push(promise);
        }

        // ÂêÑÊó•„ÅÆ„Éò„ÉÉ„ÉÄ„ÉºÁîªÂÉè„Çí‰∏¶Ë°åÂèñÂæó
        const dayImagePromises = [];
        const dayImageResults = {};

        for (const plan of plans.filter(
          (p) => p && p.itinerary && Array.isArray(p.itinerary)
        )) {
          dayImageResults[plan.trip_id] = {};

          for (const day of plan.itinerary.filter(
            (d) => d && d.city && d.city.name
          )) {
            console.log(
              `Êó•Á®ãÁîªÂÉèÂèñÂæóÈñãÂßã: ${day.city.name} (Trip: ${plan.trip_id}, Day: ${day.day})`
            );

            const promise = fetch("/api/places-photos", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                placeName: day.city.name,
              }),
            })
              .then(async (response) => {
                console.log(
                  `Êó•Á®ãÁîªÂÉè„É¨„Çπ„Éù„É≥„Çπ (${day.city.name}):`,
                  response.status
                );
                if (response.ok) {
                  const imageData = await response.json();
                  console.log(
                    `Êó•Á®ãÁîªÂÉèÂèñÂæóÊàêÂäü (${day.city.name}):`,
                    imageData
                  );
                  return {
                    trip_id: plan.trip_id,
                    day: day.day,
                    data: imageData,
                  };
                } else {
                  const errorData = await response
                    .json()
                    .catch(() => ({ error: "‰∏çÊòé„Å™„Ç®„É©„Éº" }));
                  console.warn(
                    `Êó•Á®ãÁîªÂÉèÂèñÂæóÂ§±Êïó (${day.city.name}):`,
                    response.status,
                    errorData
                  );
                }
                return null;
              })
              .catch((error) => {
                console.error(`Êó•Á®ãÁîªÂÉèÂèñÂæó„Ç®„É©„Éº (${day.city.name}):`, error);
                return null;
              });

            dayImagePromises.push(promise);
          }
        }

        // „Ç¢„ÇØ„ÉÜ„Ç£„Éì„ÉÜ„Ç£„ÅÆÁîªÂÉè„Çí‰∏¶Ë°åÂèñÂæóÔºà„Éë„Éï„Ç©„Éº„Éû„É≥„ÇπÊîπÂñÑÔºâ
        const activityImagePromises = [];
        const activityImageResults = {};

        for (const plan of plans.filter(
          (p) => p && p.itinerary && Array.isArray(p.itinerary)
        )) {
          activityImageResults[plan.trip_id] = {};

          for (const day of plan.itinerary.filter(
            (d) => d && d.activities && Array.isArray(d.activities)
          )) {
            for (const activity of day.activities.filter(
              (a) => a && a.title && a.id
            )) {
              console.log(
                `ÁîªÂÉèÂèñÂæóÈñãÂßã: ${activity.title} (Trip: ${plan.trip_id}, Activity: ${activity.id})`
              );

              const promise = fetch("/api/places-photos", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify({
                  placeName: activity.title,
                }),
              })
                .then(async (response) => {
                  console.log(
                    `ÁîªÂÉèÂèñÂæó„É¨„Çπ„Éù„É≥„Çπ (${activity.title}):`,
                    response.status,
                    response.statusText
                  );
                  if (response.ok) {
                    const imageData = await response.json();
                    console.log(`ÁîªÂÉèÂèñÂæóÊàêÂäü (${activity.title}):`, imageData);
                    return {
                      trip_id: plan.trip_id,
                      activity_id: activity.id,
                      data: imageData,
                    };
                  } else {
                    const errorData = await response
                      .json()
                      .catch(() => ({ error: "‰∏çÊòé„Å™„Ç®„É©„Éº" }));
                    console.warn(
                      `ÁîªÂÉèÂèñÂæóÂ§±Êïó (${activity.title}):`,
                      response.status,
                      errorData
                    );
                  }
                  return null;
                })
                .catch((error) => {
                  console.error(
                    `„Ç¢„ÇØ„ÉÜ„Ç£„Éì„ÉÜ„Ç£ÁîªÂÉèÂèñÂæó„Ç®„É©„Éº (${activity.title}):`,
                    error
                  );
                  return null;
                });

              activityImagePromises.push(promise);
            }
          }
        }

        // „Éí„Éº„É≠„ÉºÁîªÂÉè„ÇíË®≠ÂÆö
        try {
          const heroImageResponses = await Promise.all(heroImagePromises);
          heroImageResponses.forEach((response) => {
            if (response) {
              heroImageResults[response.trip_id] = response.data;
            }
          });
          console.log("„Éí„Éº„É≠„ÉºÁîªÂÉèÂèñÂæóÁµêÊûú:", heroImageResults);
          setHeroImages(heroImageResults);
          setAdditionalDataProgress(70);
        } catch (error) {
          console.error("„Éí„Éº„É≠„ÉºÁîªÂÉèÂèñÂæó„Å´Â§±Êïó:", error);
          setHeroImages({});
          setAdditionalDataProgress(70);
        }

        // Êó•Á®ãÁîªÂÉè„ÇíË®≠ÂÆö
        try {
          const dayImageResponses = await Promise.all(dayImagePromises);
          dayImageResponses.forEach((response) => {
            if (response) {
              if (!dayImageResults[response.trip_id]) {
                dayImageResults[response.trip_id] = {};
              }
              // ‰øÆÊ≠£: dayÁï™Âè∑„ÅßÁõ¥Êé•‰øùÂ≠ò
              dayImageResults[response.trip_id][response.day] = response.data;
            }
          });
          console.log("Êó•Á®ãÁîªÂÉèÂèñÂæóÁµêÊûú:", dayImageResults);
          setDayImages(dayImageResults);
          setAdditionalDataProgress(80);
        } catch (error) {
          console.error("Êó•Á®ãÁîªÂÉèÂèñÂæó„Å´Â§±Êïó:", error);
          setDayImages({});
          setAdditionalDataProgress(80);
        }

        // „Ç¢„ÇØ„ÉÜ„Ç£„Éì„ÉÜ„Ç£ÁîªÂÉè„ÇíË®≠ÂÆö
        try {
          const activityImageResponses = await Promise.all(
            activityImagePromises
          );
          activityImageResponses.forEach((response) => {
            if (response) {
              activityImageResults[response.trip_id][response.activity_id] =
                response.data;
            }
          });
          console.log("„Ç¢„ÇØ„ÉÜ„Ç£„Éì„ÉÜ„Ç£ÁîªÂÉèÂèñÂæóÁµêÊûú:", activityImageResults);
          setActivityImages(activityImageResults);
          setAdditionalDataProgress(90);
        } catch (error) {
          console.error("„Ç¢„ÇØ„ÉÜ„Ç£„Éì„ÉÜ„Ç£ÁîªÂÉèÂèñÂæó„Å´Â§±Êïó:", error);
          // „Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Å¶„ÇÇ„Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥„ÇíÁ∂ôÁ∂ö
          setActivityImages({});
          setAdditionalDataProgress(90);
        }

        // ÂêÑ„Éó„É©„É≥„ÅÆÁµåË∑ØÊÉÖÂ†±„Çí‰∏¶Ë°åÂèñÂæóÔºà„Éë„Éï„Ç©„Éº„Éû„É≥„ÇπÊîπÂñÑÔºâ
        const routePromises = [];
        const routeResults = {};

        for (const plan of plans) {
          routeResults[plan.trip_id] = {};

          // ÂÖ®‰Ωì„Éó„É©„É≥„É´„Éº„Éà
          const allWaypoints = [];
          for (const day of plan.itinerary || []) {
            if (day.city && day.city.name) {
              allWaypoints.push(day.city.name);
            }
          }

          if (allWaypoints.length >= 2) {
            const overallPromise = fetch("/api/directions", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ waypoints: allWaypoints }),
            })
              .then(async (response) => {
                if (response.ok) {
                  const routeData = await response.json();
                  return {
                    trip_id: plan.trip_id,
                    type: "overall",
                    data: routeData,
                  };
                }
                return null;
              })
              .catch((error) => {
                console.error(`ÂÖ®‰ΩìÁµåË∑ØÂèñÂæó„Ç®„É©„Éº (${plan.trip_id}):`, error);
                return null;
              });

            routePromises.push(overallPromise);
          }

          // ÂêÑÊó•„ÅÆ„Ç¢„ÇØ„ÉÜ„Ç£„Éì„ÉÜ„Ç£Èñì„ÅÆÁµåË∑Ø„ÇíÂèñÂæó
          for (const day of plan.itinerary || []) {
            const dailyWaypoints = [];

            for (const activity of day.activities || []) {
              if (activity.location) {
                dailyWaypoints.push(activity.location);
              }
            }

            if (dailyWaypoints.length >= 2) {
              console.log(
                `Day ${day.day} „É´„Éº„ÉàÂèñÂæó‰∏≠ (${plan.trip_id}):`,
                dailyWaypoints
              );
              const dailyPromise = fetch("/api/directions", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify({ waypoints: dailyWaypoints }),
              })
                .then(async (response) => {
                  if (response.ok) {
                    const routeData = await response.json();
                    return {
                      trip_id: plan.trip_id,
                      type: `day_${day.day}`,
                      data: routeData,
                    };
                  }
                  console.error(
                    `Day ${day.day} „É´„Éº„ÉàÂèñÂæóÂ§±Êïó (${plan.trip_id}):`,
                    response.status
                  );
                  return null;
                })
                .catch((error) => {
                  console.error(
                    `Day ${day.day} ÁµåË∑ØÂèñÂæó„Ç®„É©„Éº (${plan.trip_id}):`,
                    error
                  );
                  return null;
                });

              routePromises.push(dailyPromise);
            }
          }
        }

        // ÁµåË∑ØÊÉÖÂ†±„ÇíË®≠ÂÆö
        try {
          const routeResponses = await Promise.all(routePromises);
          routeResponses.forEach((response) => {
            if (response) {
              routeResults[response.trip_id][response.type] = response.data;
            }
          });
          console.log("„É´„Éº„ÉàÂèñÂæóÁµêÊûú:", routeResults);
          setRouteData(routeResults);
          setAdditionalDataProgress(100);
        } catch (error) {
          console.error("„É´„Éº„ÉàÊÉÖÂ†±ÂèñÂæó„Å´Â§±Êïó:", error);
          // „Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Å¶„ÇÇ„Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥„ÇíÁ∂ôÁ∂ö
          setRouteData({});
          setAdditionalDataProgress(100);
        }

        // ËøΩÂä†„Éá„Éº„ÇøÂèñÂæóÂÆå‰∫Ü
        console.log("üé® ËøΩÂä†„Éá„Éº„ÇøÂèñÂæóÂÆå‰∫Ü");
        setAdditionalDataLoading(false);
        setLoading(false);

        // Áõ¥Êé•ÈÅ∑Áßª„ÅÆÂ†¥Âêà„ÅØËøΩÂä†„Éá„Éº„ÇøÂèñÂæóÂÆå‰∫ÜÂæå„Å´Context„Çí„ÇØ„É™„Ç¢
        if (isDirectTransition) {
          console.log("üéØ ËøΩÂä†„Éá„Éº„ÇøÂèñÂæóÂÆå‰∫Ü„ÄÅContext„Çí„ÇØ„É™„Ç¢");
          clearPlanData();
        }
      } catch (error) {
        console.error("„Éá„Éº„ÇøÂèñÂæó„Ç®„É©„Éº:", error);
        setAdditionalDataLoading(false);
        setLoading(false);

        // „Ç®„É©„ÉºÊôÇ„ÇÇContext„Çí„ÇØ„É™„Ç¢
        if (isDirectTransition) {
          clearPlanData();
        }
      }
    };

    fetchData();
  }, [plans, isDirectTransition]);

  const fetchHotels = async (tripId, planData) => {
    try {
      if (!planData?.itinerary) return;

      const hotelPromises = planData.itinerary.map(async (day) => {
        if (
          !day.accommodation ||
          day.accommodation === "Âá∫Áô∫Êó•„ÅÆ„Åü„ÇÅÂÆøÊ≥ä„Å™„Åó"
        ) {
          return null;
        }

        try {
          // Ê•ΩÂ§©„Éà„É©„Éô„É´API„Çí‰ΩøÁî®„Åó„Å¶„Éõ„ÉÜ„É´Ê§úÁ¥¢
          const response = await fetch("/api/hotels", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              location: day.accommodation,
              checkin: day.day === 1 ? startDate : null,
              checkout: day.day === planData.itinerary.length ? endDate : null,
              adults: people || 2,
              roomCount: 1,
            }),
          });

          if (!response.ok) {
            throw new Error(`„Éõ„ÉÜ„É´Ê§úÁ¥¢„Ç®„É©„Éº: ${response.status}`);
          }

          const hotelData = await response.json();
          return {
            dayKey: `day_${day.day}`,
            hotels: hotelData.hotels || [],
          };
        } catch (error) {
          console.error(`Day ${day.day}„ÅÆ„Éõ„ÉÜ„É´Ê§úÁ¥¢„Ç®„É©„Éº:`, error);
          return {
            dayKey: `day_${day.day}`,
            hotels: [],
          };
        }
      });

      const hotelResults = await Promise.all(hotelPromises);
      const hotelsByDay = {};

      hotelResults.forEach((result) => {
        if (result) {
          hotelsByDay[result.dayKey] = result.hotels;
        }
      });

      setHotels((prev) => ({
        ...prev,
        [tripId]: hotelsByDay,
      }));
    } catch (error) {
      console.error("„Éõ„ÉÜ„É´Ê§úÁ¥¢„ÅÆÂÖ®‰Ωì„Ç®„É©„Éº:", error);
    }
  };

  // fetchRoutesÈñ¢Êï∞„ÅÆ‰øÆÊ≠£
  const fetchDetailedRoutes = async (tripId, planData) => {
    try {
      if (!planData?.itinerary) return;

      console.log(`=== Ë©≥Á¥∞ÁµåË∑ØÊé¢Á¥¢ÈñãÂßã: ${tripId} ===`);

      const allRouteSegments = {};
      const routePromises = [];
      const totalDistanceTracker = { total: 0 };

      // ÂêÑÊó•„ÅÆË©≥Á¥∞ÁµåË∑Ø„ÇíÂèñÂæó
      for (const day of planData.itinerary) {
        // day.activities„ÅåÂ≠òÂú®„Åó„Å™„ÅÑÂ†¥Âêà„ÅØ„Çπ„Ç≠„ÉÉ„Éó
        if (!day.activities || !Array.isArray(day.activities)) {
          console.warn(
            `Day ${day.day}: activities„ÅåÂ≠òÂú®„Åó„Å™„ÅÑ„Åã„ÄÅÈÖçÂàó„Åß„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì`,
            day
          );
          continue;
        }

        const dayKey = `day_${day.day}`;
        console.log(`\n--- Day ${day.day} ÈñãÂßã ---`);

        allRouteSegments[dayKey] = {
          segments: [],
          dayTotalDistance: 0,
          dayTotalDuration: 0,
          crossDaySegment: null,
        };

        // „Åù„ÅÆÊó•„ÅÆ„Ç¢„ÇØ„ÉÜ„Ç£„Éì„ÉÜ„Ç£Ôºàsearch_query„Åå„ÅÇ„Çã„ÇÇ„ÅÆ„ÅÆ„ÅøÔºâ
        const dayActivities = day.activities.filter(
          (activity) =>
            activity &&
            activity.search_query &&
            activity.search_query.trim() !== ""
        );

        console.log(
          `Day ${day.day} ÂÖ®„Ç¢„ÇØ„ÉÜ„Ç£„Éì„ÉÜ„Ç£:`,
          day.activities.map((a) => ({
            title: a?.title || "‰∏çÊòé",
            search_query: a?.search_query || "„Å™„Åó",
          }))
        );
        console.log(
          `Day ${day.day} ÊúâÂäπ„Å™„Ç¢„ÇØ„ÉÜ„Ç£„Éì„ÉÜ„Ç£:`,
          dayActivities.map((a) => a.title)
        );

        // ÂâçÊó•„ÅÆÊúÄÂæå„ÅÆ„Ç¢„ÇØ„ÉÜ„Ç£„Éì„ÉÜ„Ç£„Åã„Çâ‰ªäÊó•„ÅÆÊúÄÂàù„ÅÆ„Ç¢„ÇØ„ÉÜ„Ç£„Éì„ÉÜ„Ç£„Å∏„ÅÆÁßªÂãïÔºàÊó•Ë∑®„ÅéÔºâ
        if (day.day > 1 && dayActivities.length > 0) {
          const previousDay = planData.itinerary.find(
            (d) => d.day === day.day - 1
          );
          if (
            previousDay &&
            previousDay.activities &&
            Array.isArray(previousDay.activities)
          ) {
            const previousDayActivities = previousDay.activities.filter(
              (activity) =>
                activity &&
                activity.search_query &&
                activity.search_query.trim() !== ""
            );

            if (previousDayActivities.length > 0) {
              const lastActivityPrevDay =
                previousDayActivities[previousDayActivities.length - 1];
              const firstActivityToday = dayActivities[0];

              console.log(
                `üåÖ Êó•Ë∑®„ÅéÁßªÂãïË®≠ÂÆö: ${lastActivityPrevDay.title} ‚Üí ${firstActivityToday.title}`
              );

              // Êó•Ë∑®„Åé„ÅÆÁµåË∑Ø„ÇíÂèñÂæó
              const crossDayPromise = fetchSingleRouteSegment(
                {
                  type: "activity",
                  name:
                    lastActivityPrevDay.location || lastActivityPrevDay.title,
                  searchQuery: lastActivityPrevDay.search_query,
                  id: lastActivityPrevDay.id,
                  title: lastActivityPrevDay.title,
                },
                {
                  type: "activity",
                  name: firstActivityToday.location || firstActivityToday.title,
                  searchQuery: firstActivityToday.search_query,
                  id: firstActivityToday.id,
                  title: firstActivityToday.title,
                },
                day.day,
                "cross_day",
                tripId,
                totalDistanceTracker
              );

              routePromises.push(crossDayPromise);
            } else {
              console.log(
                `‚ö†Ô∏è Day ${
                  day.day - 1
                } „Å´ÊúâÂäπ„Å™„Ç¢„ÇØ„ÉÜ„Ç£„Éì„ÉÜ„Ç£„Åå„Å™„ÅÑ„Åü„ÇÅ„ÄÅÊó•Ë∑®„ÅéÁßªÂãï„Çí„Çπ„Ç≠„ÉÉ„Éó`
              );
            }
          }
        }

        // „Åù„ÅÆÊó•„ÅÆ„Ç¢„ÇØ„ÉÜ„Ç£„Éì„ÉÜ„Ç£Èñì„ÅÆÁßªÂãï
        for (let i = 0; i < dayActivities.length - 1; i++) {
          const fromActivity = dayActivities[i];
          const toActivity = dayActivities[i + 1];

          console.log(
            `üöó Day ${day.day} ÁßªÂãï ${i + 1}: ${fromActivity.title} ‚Üí ${
              toActivity.title
            }`
          );

          const segmentPromise = fetchSingleRouteSegment(
            {
              type: "activity",
              name: fromActivity.location || fromActivity.title,
              searchQuery: fromActivity.search_query,
              id: fromActivity.id,
              title: fromActivity.title,
            },
            {
              type: "activity",
              name: toActivity.location || toActivity.title,
              searchQuery: toActivity.search_query,
              id: toActivity.id,
              title: toActivity.title,
            },
            day.day,
            i,
            tripId,
            totalDistanceTracker
          );

          routePromises.push(segmentPromise);
        }
      }

      // ÂÖ®„Å¶„ÅÆÁµåË∑Ø„Çª„Ç∞„É°„É≥„Éà„Çí‰∏¶Ë°åÂèñÂæó
      console.log(`\nüìä Á∑èÁµåË∑Ø„Çª„Ç∞„É°„É≥„ÉàÊï∞: ${routePromises.length}`);

      if (routePromises.length === 0) {
        console.log(
          "‚ö†Ô∏è ÁµåË∑Ø„Çª„Ç∞„É°„É≥„Éà„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇÁµåË∑Ø„Éá„Éº„Çø„ÅÆË®≠ÂÆö„Çí„Çπ„Ç≠„ÉÉ„Éó„Åó„Åæ„Åô„ÄÇ"
        );
        return;
      }

      const routeResults = await Promise.all(routePromises);

      // ÁµêÊûú„ÇíÊï¥ÁêÜ
      console.log(`\n=== ÁµåË∑ØÁµêÊûú„ÅÆÊï¥ÁêÜ ===`);
      routeResults.forEach((result, index) => {
        console.log(`ÁµêÊûú ${index + 1}:`, {
          success: result?.success,
          day: result?.day,
          segmentIndex: result?.segmentIndex,
          distance: result?.data?.distance_km,
          duration: result?.data?.duration_minutes,
        });

        if (result && result.success) {
          const dayKey = `day_${result.day}`;
          if (!allRouteSegments[dayKey]) {
            allRouteSegments[dayKey] = {
              segments: [],
              dayTotalDistance: 0,
              dayTotalDuration: 0,
              crossDaySegment: null,
            };
          }

          if (result.segmentIndex === "cross_day") {
            // Êó•Ë∑®„Åé„Çª„Ç∞„É°„É≥„Éà
            allRouteSegments[dayKey].crossDaySegment = result.data;
            console.log(`‚úÖ Êó•Ë∑®„Åé„Çª„Ç∞„É°„É≥„ÉàË®≠ÂÆö: Day ${result.day}`, {
              from: result.data.from.title,
              to: result.data.to.title,
              distance: result.data.distance_km,
              duration: result.data.duration_minutes,
            });
          } else {
            // ÈÄöÂ∏∏„ÅÆ„Çª„Ç∞„É°„É≥„Éà
            allRouteSegments[dayKey].segments.push(result.data);
          }

          allRouteSegments[dayKey].dayTotalDistance +=
            result.data.distance_km || 0;
          allRouteSegments[dayKey].dayTotalDuration +=
            result.data.duration_minutes || 0;
        } else {
          console.error("‚ùå ÁµåË∑ØÂèñÂæóÂ§±Êïó:", result);
        }
      });

      // ÂÖ®‰Ωì„ÅÆÁ∑èÁßªÂãïË∑ùÈõ¢„Å®‰∫§ÈÄöË≤ª„ÇíË®àÁÆó
      const totalDistance = totalDistanceTracker.total;
      const totalDuration = Object.values(allRouteSegments).reduce(
        (total, day) => total + day.dayTotalDuration,
        0
      );
      const totalTransportationCost = Math.round(totalDistance * 28);

      console.log(`\n=== ÊúÄÁµÇÁµêÊûú ===`);
      console.log(`Á∑èÁßªÂãïË∑ùÈõ¢: ${Math.round(totalDistance * 10) / 10} km`);
      console.log(`Á∑èÁßªÂãïÊôÇÈñì: ${totalDuration} ÂàÜ`);
      console.log(`Á∑è‰∫§ÈÄöË≤ª: ¬•${totalTransportationCost.toLocaleString()}`);

      // ÂêÑÊó•„ÅÆË©≥Á¥∞„É≠„Ç∞
      Object.keys(allRouteSegments).forEach((dayKey) => {
        const dayData = allRouteSegments[dayKey];
        console.log(`${dayKey}:`, {
          segments: dayData.segments.length,
          crossDay: !!dayData.crossDaySegment,
          totalDistance: Math.round(dayData.dayTotalDistance * 10) / 10,
          totalDuration: dayData.dayTotalDuration,
        });
      });

      // ÂÖ®‰Ωì„É´„Éº„ÉàÊÉÖÂ†±„ÇíË®≠ÂÆö
      const finalRouteData = {
        ...allRouteSegments,
        overall: {
          route: {
            distance_km: totalDistance,
            duration_minutes: totalDuration,
            mode: "driving",
            total_cost: totalTransportationCost,
          },
        },
      };

      console.log(`\nüì§ setRouteData „Å´Ë®≠ÂÆö„Åô„Çã„Éá„Éº„Çø:`, finalRouteData);

      setRouteData((prev) => ({
        ...prev,
        [tripId]: finalRouteData,
      }));
    } catch (error) {
      console.error("‚ùå Ë©≥Á¥∞ÁµåË∑ØÊé¢Á¥¢„Ç®„É©„Éº:", error);
    }
  };

  // Âçò‰∏Ä„ÅÆÁµåË∑Ø„Çª„Ç∞„É°„É≥„Éà„ÇíÂèñÂæóÔºàÁ∑èË∑ùÈõ¢ËøΩË∑°Ê©üËÉΩ‰ªò„ÅçÔºâ
  const fetchSingleRouteSegment = async (
    from,
    to,
    day,
    segmentIndex,
    tripId,
    totalDistanceTracker
  ) => {
    try {
      console.log(`ÁµåË∑Ø„Çª„Ç∞„É°„É≥„ÉàÂèñÂæó: Day ${day}, ${from.name} ‚Üí ${to.name}`);

      const response = await fetch("/api/directions", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          origin: from.searchQuery,
          destination: to.searchQuery,
          mode: "driving",
        }),
      });

      if (!response.ok) {
        throw new Error(`ÁµåË∑ØÂèñÂæó„Ç®„É©„Éº: ${response.status}`);
      }

      const routeData = await response.json();
      const distance = routeData.distance_km || 0;

      // Á∑èË∑ùÈõ¢„Å´ËøΩÂä†
      totalDistanceTracker.total += distance;

      return {
        success: true,
        day: day,
        segmentIndex: segmentIndex,
        tripId: tripId,
        data: {
          from: from,
          to: to,
          distance_km: distance,
          duration_minutes: routeData.duration_minutes || 0,
          polyline: routeData.polyline || "",
          static_map_url: routeData.static_map_url || "",
          directions: routeData.directions || [],
          is_cross_day: segmentIndex === "cross_day",
        },
      };
    } catch (error) {
      console.error(
        `ÁµåË∑Ø„Çª„Ç∞„É°„É≥„ÉàÂèñÂæó„Ç®„É©„Éº (Day ${day}, ${from.name} ‚Üí ${to.name}):`,
        error
      );
      return {
        success: false,
        day: day,
        segmentIndex: segmentIndex,
        error: error.message,
      };
    }
  };

  // ÂêÑÊó•„ÅÆÁµ±Âêà„Éû„ÉÉ„Éó„ÇíÁîüÊàê
  const generateDayMaps = async (tripId, planData, routeSegments) => {
    try {
      for (const day of planData.itinerary) {
        const dayKey = `day_${day.day}`;
        const daySegments = routeSegments[dayKey];

        if (!daySegments || daySegments.segments.length === 0) {
          console.log(`Day ${day.day}: ÁµåË∑Ø„Çª„Ç∞„É°„É≥„Éà„Å™„Åó`);
          continue;
        }

        // „Åù„ÅÆÊó•„ÅÆ„Åô„Åπ„Å¶„ÅÆ„Éù„Ç§„É≥„Éà„ÇíÂèéÈõÜ
        const allPoints = [];
        const allPolylines = [];

        daySegments.segments.forEach((segment) => {
          if (!allPoints.some((p) => p.name === segment.from.name)) {
            allPoints.push(segment.from);
          }
          if (!allPoints.some((p) => p.name === segment.to.name)) {
            allPoints.push(segment.to);
          }
          if (segment.polyline) {
            allPolylines.push(segment.polyline);
          }
        });

        // Áµ±Âêà„Éû„ÉÉ„Éó„ÇíÁîüÊàê
        try {
          const mapResponse = await fetch("/api/generate-day-map", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              waypoints: allPoints.map((p) => p.searchQuery),
              polylines: allPolylines,
              day: day.day,
            }),
          });

          if (mapResponse.ok) {
            const mapData = await mapResponse.json();

            // Êó¢Â≠ò„ÅÆrouteData„ÇíÊõ¥Êñ∞
            setRouteData((prev) => ({
              ...prev,
              [tripId]: {
                ...prev[tripId],
                [dayKey]: {
                  segments: daySegments.segments,
                  route: {
                    distance_km: daySegments.totalDistance,
                    duration_minutes: daySegments.totalDuration,
                    mode: "driving",
                  },
                  static_map_url: mapData.static_map_url,
                },
              },
            }));
          }
        } catch (error) {
          console.error(`Day ${day.day} „Éû„ÉÉ„ÉóÁîüÊàê„Ç®„É©„Éº:`, error);
        }
      }
    } catch (error) {
      console.error("Êó•Âà•„Éû„ÉÉ„ÉóÁîüÊàê„Ç®„É©„Éº:", error);
    }
  };

  // ÂÖ®‰Ωì„É´„Éº„Éà„ÇíÁîüÊàê
  const generateOverallRoute = async (tripId, planData) => {
    try {
      const majorPoints = planData.itinerary
        .map((day) => ({
          name: day.city?.name || day.accommodation,
          searchQuery: day.city?.name || day.accommodation,
        }))
        .filter((point) => point.searchQuery);

      if (majorPoints.length < 2) return;

      const response = await fetch("/api/directions", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          waypoints: majorPoints.map((p) => p.searchQuery),
          optimize: false, // Êó•Á®ãÈ†ÜÂ∫è„ÇíÁ∂≠ÊåÅ
        }),
      });

      if (response.ok) {
        const overallData = await response.json();

        setRouteData((prev) => ({
          ...prev,
          [tripId]: {
            ...prev[tripId],
            overall: {
              route: {
                distance_km: overallData.distance_km,
                duration_minutes: overallData.duration_minutes,
                mode: "driving",
              },
              static_map_url: overallData.static_map_url,
            },
          },
        }));
      }
    } catch (error) {
      console.error("ÂÖ®‰Ωì„É´„Éº„ÉàÁîüÊàê„Ç®„É©„Éº:", error);
    }
  };

  // Êó¢Â≠ò„ÅÆuseEffect„ÅÆÁµåË∑ØÂèñÂæóÈÉ®ÂàÜ„ÇíÁΩÆ„ÅçÊèõ„Åà
  useEffect(() => {
    if (plans.length === 0 || !isClient) return;

    const fetchData = async () => {
      try {
        // ‰ΩçÁΩÆÊÉÖÂ†±„Å®„Éõ„ÉÜ„É´ÊÉÖÂ†±„ÅÆÂèñÂæó
        // ... Êó¢Â≠ò„ÅÆ„Éõ„ÉÜ„É´„ÉªÁîªÂÉèÂèñÂæó„Ç≥„Éº„Éâ ...

        // Ë©≥Á¥∞ÁµåË∑ØÊÉÖÂ†±„ÇíÂèñÂæóÔºàÊñ∞„Åó„ÅÑÂÆüË£ÖÔºâ
        for (const plan of plans) {
          await fetchDetailedRoutes(plan.trip_id, plan);
        }

        setLoading(false);
      } catch (error) {
        console.error("„Éá„Éº„ÇøÂèñÂæó„Ç®„É©„Éº:", error);
        setLoading(false);
      }
    };

    fetchData();
  }, [plans]);

  const handlePlanSelect = (planIndex) => {
    setSelectedPlan(planIndex);
    setExpandedDay(null);
  };

  const handleConfirmPlan = () => {
    // „Éõ„ÉÜ„É´ÊÉÖÂ†±„ÇíÂê´„ÇÄ„Éó„É©„É≥„Éá„Éº„Çø„ÇíÊ∫ñÂÇô
    const planDataWithHotels = {
      ...selectedPlanData,
      hotels: hotels[selectedPlanData.trip_id] || null
    };

    if (startDate && endDate) {
      // Êó•Á®ã„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÄÅ„Åù„ÅÆÊÉÖÂ†±„ÇíÂê´„ÇÅ„Å¶Á¢∫ÂÆöÁîªÈù¢„Å´ÈÅ∑Áßª
      const planWithDates = {
        ...planDataWithHotels,
        travel_dates: {
          startDate: startDate,
          endDate: endDate,
          duration: (() => {
            const start = new Date(startDate);
            const end = new Date(endDate);
            const days = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;
            return `${days}Êó•Èñì`;
          })(),
        },
      };
      localStorage.setItem(
        "selectedPlanWithDates",
        JSON.stringify(planWithDates)
      );
      // confirmedPlan„Å´„ÇÇ‰øùÂ≠òÔºàconfirmÁîªÈù¢Áî®Ôºâ
      localStorage.setItem("confirmedPlan", JSON.stringify(planWithDates));
      console.log("„Éó„É©„É≥Á¢∫ÂÆöÔºàÊó•Á®ã„ÅÇ„ÇäÔºâ:", planWithDates);
    } else {
      // Êó•Á®ã„ÅåÊú™Ë®≠ÂÆö„ÅÆÂ†¥Âêà„ÅØÂÖÉ„ÅÆ„Éó„É©„É≥„Éá„Éº„Çø„ÅÆ„Åø
      localStorage.setItem(
        "selectedPlanWithDates",
        JSON.stringify(planDataWithHotels)
      );
      // confirmedPlan„Å´„ÇÇ‰øùÂ≠òÔºàconfirmÁîªÈù¢Áî®Ôºâ
      localStorage.setItem("confirmedPlan", JSON.stringify(planDataWithHotels));
      console.log("„Éó„É©„É≥Á¢∫ÂÆöÔºàÊó•Á®ã„Å™„ÅóÔºâ:", planDataWithHotels);
    }
    router.push("/confirm");
  };

  const handleDateConfirm = () => {
    if (!startDate || !endDate) {
      alert("Âá∫Áô∫Êó•„Å®Â∏∞ÁùÄÊó•„Çí‰∏°ÊñπÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ");
      return;
    }

    const start = new Date(startDate);
    const end = new Date(endDate);

    if (start >= end) {
      alert("Â∏∞ÁùÄÊó•„ÅØÂá∫Áô∫Êó•„Çà„ÇäÂæå„ÅÆÊó•‰ªò„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ");
      return;
    }

    // Êó•Á®ã„ÅÆÂ∑Æ„ÇíË®àÁÆó
    const daysDiff = Math.ceil((end - start) / (1000 * 60 * 60 * 24));
    const planDuration = selectedPlanData?.hero?.duration || "";
    const expectedDays = parseInt(planDuration.match(/\d+/)?.[0]) || 0;

    if (daysDiff !== expectedDays && expectedDays > 0) {
      if (
        !confirm(
          `„Éó„É©„É≥„ÅØ${expectedDays}Êó•Èñì„Åß„Åô„Åå„ÄÅÈÅ∏Êäû„Åï„Çå„ÅüÊúüÈñì„ÅØ${daysDiff}Êó•Èñì„Åß„Åô„ÄÇ„Åì„ÅÆ„Åæ„ÅæÁ∂öË°å„Åó„Åæ„Åô„ÅãÔºü`
        )
      ) {
        return;
      }
    }

    setShowDatePicker(false);
    alert(`ÊóÖË°åÊó•Á®ã„ÅåË®≠ÂÆö„Åï„Çå„Åæ„Åó„Åü: ${startDate} „Äú ${endDate}`);
  };

  const handleRegenerate = () => {
    if (confirm("Êñ∞„Åó„ÅÑ„Éó„É©„É≥„ÇíÁîüÊàê„Åó„Åæ„Åô„ÅãÔºü")) {
      router.push("/");
    }
  };

  const handleRegenerateWithPrompt = async () => {
    if (!additionalPrompt.trim()) {
      alert("ËøΩÂä†„ÅÆË¶ÅÊúõ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ");
      return;
    }

    setShowRegenerateForm(false);
    setIsRegenerating(true);
    setRegenerationProgress(0);

    let progressInterval;

    try {
      console.log("=== „Éó„É©„É≥‰øÆÊ≠£ÈñãÂßã ===");
      console.log("ÈÅ∏Êäû„Åï„Çå„Åü„Éó„É©„É≥:", selectedPlan);
      console.log("ÂÖÉ„ÅÆ„Éó„É©„É≥ ID:", selectedPlanData?.trip_id);
      console.log("‰øÆÊ≠£Ë¶ÅÊúõ:", additionalPrompt);

      // ÈÄ≤Êçó„Ç∑„Éü„É•„É¨„Éº„Ç∑„Éß„É≥
      progressInterval = setInterval(() => {
        setRegenerationProgress((prev) => {
          if (prev >= 95) {
            clearInterval(progressInterval);
            return 95;
          }
          const increment = prev < 30 ? 8 : prev < 60 ? 5 : prev < 80 ? 3 : 1;
          return prev + increment;
        });
      }, 800);

      // APIÂëº„Å≥Âá∫„Åó
      const response = await fetch("/api/modify-travel-plan", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          original_plan: selectedPlanData,
          plan_number: selectedPlan + 1,
          modification_request: additionalPrompt.trim(),
          full_plans_data: plans,
        }),
      });

      console.log("=== API„É¨„Çπ„Éù„É≥„Çπ ===");
      console.log("Status:", response.status);
      console.log("Status Text:", response.statusText);
      console.log("OK:", response.ok);

      // ÈÄ≤Êçó„Çí100%„Å´
      if (progressInterval) {
        clearInterval(progressInterval);
        progressInterval = null;
      }
      setRegenerationProgress(100);

      // „É¨„Çπ„Éù„É≥„Çπ„ÉÜ„Ç≠„Çπ„Éà„ÇíÂèñÂæó
      const responseText = await response.text();
      console.log("=== „É¨„Çπ„Éù„É≥„Çπ„ÉÜ„Ç≠„Çπ„Éà ===");
      console.log("Length:", responseText.length);
      console.log("Preview:", responseText.substring(0, 500));

      if (response.ok) {
        let responseData;
        try {
          responseData = JSON.parse(responseText);
          console.log("=== JSON„Éë„Éº„ÇπÊàêÂäü ===");
          console.log("Response keys:", Object.keys(responseData));
          console.log("Success flag:", responseData.success);
        } catch (parseError) {
          console.error("=== JSON„Éë„Éº„Çπ„Ç®„É©„Éº ===", parseError);
          console.error("Raw response:", responseText);
          throw new Error("„Çµ„Éº„Éê„Éº„Åã„Çâ„ÅÆÂøúÁ≠î„ÅåÁÑ°Âäπ„Å™JSONÂΩ¢Âºè„Åß„Åô");
        }

        // API„É¨„Çπ„Éù„É≥„ÇπÂΩ¢Âºè„Å´Âêà„Çè„Åõ„ÅüÊ§úË®º
        if (!responseData.success) {
          throw new Error("„Éó„É©„É≥„ÅÆ‰øÆÊ≠£„Å´Â§±Êïó„Åó„Åæ„Åó„Åü");
        }

        if (!responseData.modified_plan) {
          throw new Error("‰øÆÊ≠£„Åï„Çå„Åü„Éó„É©„É≥„Éá„Éº„Çø„ÅåËøî„Åï„Çå„Åæ„Åõ„Çì„Åß„Åó„Åü");
        }

        const modifiedPlan = responseData.modified_plan;

        // „Éó„É©„É≥„Éá„Éº„Çø„ÅÆÂü∫Êú¨Ê§úË®º
        if (!modifiedPlan.trip_id) {
          console.warn("Trip ID„Åå‰∏çË∂≥„Åó„Å¶„ÅÑ„Çã„Åü„ÇÅ„ÄÅËá™ÂãïÁîüÊàê„Åó„Åæ„Åô");
          modifiedPlan.trip_id = `modified_${
            selectedPlanData.trip_id
          }_${Date.now()}`;
        }

        if (!modifiedPlan.hero) {
          console.warn("HeroÊÉÖÂ†±„Åå‰∏çË∂≥„Åó„Å¶„ÅÑ„Çã„Åü„ÇÅ„ÄÅÂÖÉ„ÅÆ„Éá„Éº„Çø„Çí‰ΩøÁî®„Åó„Åæ„Åô");
          modifiedPlan.hero = selectedPlanData.hero;
        }

        if (!modifiedPlan.itinerary || !Array.isArray(modifiedPlan.itinerary)) {
          console.warn(
            "ItineraryÊÉÖÂ†±„Åå‰∏çË∂≥„Åó„Å¶„ÅÑ„Çã„Åü„ÇÅ„ÄÅÂÖÉ„ÅÆ„Éá„Éº„Çø„Çí‰ΩøÁî®„Åó„Åæ„Åô"
          );
          modifiedPlan.itinerary = selectedPlanData.itinerary;
        }

        console.log("=== ‰øÆÊ≠£„Åï„Çå„Åü„Éó„É©„É≥ ===");
        console.log("Trip ID:", modifiedPlan.trip_id);
        console.log("Title:", modifiedPlan.hero?.title);
        console.log("Days:", modifiedPlan.itinerary?.length);
        console.log("Summary:", modifiedPlan.modification_summary);

        // Êó¢Â≠ò„ÅÆ„Éó„É©„É≥ÈÖçÂàó„ÇíÊõ¥Êñ∞ÔºàÈÅ∏Êäû„Åï„Çå„Åü„Éó„É©„É≥„ÅÆ„Åø„ÇíÁΩÆ„ÅçÊèõ„ÅàÔºâ
        const updatedPlans = [...plans];
        updatedPlans[selectedPlan] = modifiedPlan;

        console.log("=== „Éó„É©„É≥ÈÖçÂàóÊõ¥Êñ∞ ===");
        console.log("Êõ¥Êñ∞Ââç„Éó„É©„É≥Êï∞:", plans.length);
        console.log("Êõ¥Êñ∞Âæå„Éó„É©„É≥Êï∞:", updatedPlans.length);
        console.log("‰øÆÊ≠£ÂØæË±°„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ:", selectedPlan);

        // „É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„Å´‰øùÂ≠ò
        localStorage.setItem("travelPlans", JSON.stringify(updatedPlans));

        // ÂÆå‰∫ÜÂá¶ÁêÜ
        setTimeout(() => {
          setPlans(updatedPlans);
          setSelectedPlan(selectedPlan); // Âêå„Åò„Éó„É©„É≥„ÇíÂÜçÈÅ∏Êäû
          setIsRegenerating(false);
          setRegenerationProgress(0);

          const planTitle =
            modifiedPlan.hero?.title || `„Éó„É©„É≥ ${selectedPlan + 1}`;
          const summary =
            modifiedPlan.modification_summary || "Ë¶ÅÊúõ„Å´Âü∫„Å•„ÅÑ„Å¶Êõ¥Êñ∞„Åï„Çå„Åæ„Åó„Åü";

          alert(
            `‚úÖ „Éó„É©„É≥‰øÆÊ≠£ÂÆå‰∫Ü\n\n„Äå${planTitle}„Äç\n\n‰øÆÊ≠£ÂÜÖÂÆπ: ${summary}`
          );
        }, 1000);
      } else {
        // „Ç®„É©„Éº„É¨„Çπ„Éù„É≥„Çπ„ÅÆÂá¶ÁêÜ
        console.error("=== API„Ç®„É©„Éº ===");
        console.error("Status:", response.status);
        console.error("Response:", responseText);

        let errorMessage = "„Éó„É©„É≥„ÅÆ‰øÆÊ≠£„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ";

        try {
          const errorData = JSON.parse(responseText);
          if (errorData.error) {
            errorMessage = errorData.error;
          }
          if (errorData.details) {
            console.error("Error details:", errorData.details);
            errorMessage += `\nË©≥Á¥∞: ${errorData.details}`;
          }
        } catch {
          // JSON „Éë„Éº„Çπ„Å´Â§±Êïó„Åó„ÅüÂ†¥Âêà„ÅÆ„Ç®„É©„Éº„Éè„É≥„Éâ„É™„É≥„Ç∞
          if (response.status === 429) {
            errorMessage =
              "„É™„ÇØ„Ç®„Çπ„Éà„ÅåÂ§ö„Åô„Åé„Åæ„Åô„ÄÇ„Åó„Å∞„Çâ„ÅèÂæÖ„Å£„Å¶„Åã„ÇâÂÜçË©¶Ë°å„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ";
          } else if (response.status === 401) {
            errorMessage =
              "APIË™çË®º„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇÁÆ°ÁêÜËÄÖ„Å´„ÅäÂïè„ÅÑÂêà„Çè„Åõ„Åè„Å†„Åï„ÅÑ„ÄÇ";
          } else if (response.status === 500) {
            errorMessage =
              "„Çµ„Éº„Éê„ÉºÂÜÖÈÉ®„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ„Åó„Å∞„Çâ„ÅèÂæÖ„Å£„Å¶„Åã„ÇâÂÜçË©¶Ë°å„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ";
          } else {
            errorMessage += ` (HTTP ${response.status})`;
          }
        }

        throw new Error(errorMessage);
      }
    } catch (error) {
      console.error("=== „Éó„É©„É≥‰øÆÊ≠£„Ç®„É©„Éº (ÂÖ®‰Ωì) ===", error);

      let userMessage = "„Éó„É©„É≥„ÅÆ‰øÆÊ≠£‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ";

      if (
        error.message.includes("fetch") ||
        error.message.includes("Failed to fetch")
      ) {
        userMessage =
          "„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØÊé•Á∂ö„Å´ÂïèÈ°å„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ„Ç§„É≥„Çø„Éº„Éç„ÉÉ„ÉàÊé•Á∂ö„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ";
      } else if (
        error.message.includes("JSON") ||
        error.message.includes("parse")
      ) {
        userMessage =
          "„Çµ„Éº„Éê„Éº„Åã„Çâ„ÅÆÂøúÁ≠îÂΩ¢Âºè„Å´ÂïèÈ°å„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ„Åó„Å∞„Çâ„ÅèÂæÖ„Å£„Å¶„Åã„ÇâÂÜçË©¶Ë°å„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ";
      } else if (error.message.includes("APIË™çË®º")) {
        userMessage =
          "„Çµ„Éº„Éì„Çπ„ÅÆË™çË®º„Å´ÂïèÈ°å„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇÁÆ°ÁêÜËÄÖ„Å´„ÅäÂïè„ÅÑÂêà„Çè„Åõ„Åè„Å†„Åï„ÅÑ„ÄÇ";
      } else if (error.message.includes("„É™„ÇØ„Ç®„Çπ„Éà„ÅåÂ§ö„Åô„Åé„Åæ„Åô")) {
        userMessage =
          "„É™„ÇØ„Ç®„Çπ„Éà„ÅåÂ§ö„Åô„Åé„Åæ„Åô„ÄÇ1ÂàÜ„Åª„Å©ÂæÖ„Å£„Å¶„Åã„ÇâÂÜçË©¶Ë°å„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ";
      } else if (error.message.includes("„Çµ„Éº„Éê„ÉºÂÜÖÈÉ®„Ç®„É©„Éº")) {
        userMessage =
          "„Çµ„Éº„Éê„Éº„ÅßÂïèÈ°å„ÅåÁô∫Áîü„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ„Åó„Å∞„Çâ„ÅèÂæÖ„Å£„Å¶„Åã„ÇâÂÜçË©¶Ë°å„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ";
      } else if (error.message) {
        userMessage = error.message;
      }

      alert(`‚ùå „Ç®„É©„Éº\n\n${userMessage}`);
    } finally {
      // Á¢∫ÂÆü„Å´„ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„Éó
      if (progressInterval) {
        clearInterval(progressInterval);
      }
      setIsRegenerating(false);
      setRegenerationProgress(0);
      setAdditionalPrompt("");
    }
  };

  // „Ç≠„É£„É≥„Çª„É´Âá¶ÁêÜ
  const handleRegenerationCancel = () => {
    setIsRegenerating(false);
    setRegenerationProgress(0);
    setShowRegenerateForm(true);
  };

  // ÂÖ±Êúâ„É™„É≥„ÇØ„Çí„Ç≥„Éî„Éº„Åô„ÇãÊ©üËÉΩ
  const handleCopyShareLink = async () => {
    const currentUrl = window.location.href;

    try {
      await navigator.clipboard.writeText(currentUrl);
      setShowCopySuccess(true);
      setTimeout(() => setShowCopySuccess(false), 2000);
    } catch (err) {
      console.error("„Ç≥„Éî„Éº„Å´Â§±Êïó„Åó„Åæ„Åó„Åü:", err);
      // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ: „ÉÜ„Ç≠„Çπ„Éà„ÇíÈÅ∏ÊäûÁä∂ÊÖã„Å´„Åô„Çã
      const textArea = document.createElement("textarea");
      textArea.value = currentUrl;
      document.body.appendChild(textArea);
      textArea.select();
      try {
        document.execCommand("copy");
        setShowCopySuccess(true);
        setTimeout(() => setShowCopySuccess(false), 2000);
      } catch (fallbackError) {
        console.error("„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ„ÇÇÂ§±Êïó„Åó„Åæ„Åó„Åü:", fallbackError);
      }
      document.body.removeChild(textArea);
    }
  };

  if (loading) {
    return (
      <div className="min-h-screen bg-gray-50 flex items-center justify-center">
        <div className="text-center">
          <div className="animate-spin rounded-full h-16 w-16 border-b-2 border-blue-600 mx-auto mb-4"></div>
          <h2 className="text-xl font-semibold text-gray-900 mb-2">
            „Éó„É©„É≥„ÇíÊ∫ñÂÇô‰∏≠...
          </h2>
          <p className="text-gray-600">‰ΩçÁΩÆÊÉÖÂ†±„Å®„Éõ„ÉÜ„É´ÊÉÖÂ†±„ÇíÂèñÂæó„Åó„Å¶„ÅÑ„Åæ„Åô</p>
        </div>
      </div>
    );
  }

  const handleBookingClick = (type) => {
    console.log(`${type}„ÅÆ‰∫àÁ¥Ñ„ÇíÈñãÂßã`);
  };

  const selectedPlanData = selectedPlan !== null ? plans[selectedPlan] : null;

  // SSR‰∏≠„Åæ„Åü„ÅØ„Éó„É©„É≥„Éá„Éº„Çø„Åå„Å™„ÅÑÂ†¥Âêà„ÅÆ„É≠„Éº„Éá„Ç£„É≥„Ç∞Ë°®Á§∫
  if (!isClient || authLoading || loading || !planId) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center">
        <div className="text-center">
          <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
          <p className="text-gray-600 mb-4">
            {!isClient
              ? "Ë™≠„ÅøËæº„Åø‰∏≠..."
              : authLoading
              ? "Ë™çË®ºÁä∂ÊÖã„ÇíÁ¢∫Ë™ç‰∏≠..."
              : !planId
              ? "„Éó„É©„É≥ID„ÇíÂèñÂæó‰∏≠..."
              : "„Éó„É©„É≥„Éá„Éº„Çø„ÇíÁ¢∫Ë™ç‰∏≠..."}
          </p>
          <p className="text-gray-500 text-sm">
            planId: {planId || "ÂèñÂæó‰∏≠..."}
          </p>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gray-50">
      {/* ÈÄ≤Êçó„É¢„Éº„ÉÄ„É´ */}
      <ProgressModalDynamic
        isVisible={isRegenerating}
        progress={regenerationProgress}
        totalPlans={1}
        onCancel={handleRegenerationCancel}
        customTitle="„Éó„É©„É≥„Çí„Ç´„Çπ„Çø„Éû„Ç§„Ç∫‰∏≠..."
        customSubtitle="„ÅÇ„Å™„Åü„ÅÆË¶ÅÊúõ„ÇíÂèçÊò†„Åó„ÅüÊñ∞„Åó„ÅÑ„Éó„É©„É≥„ÇíÁîüÊàê„Åó„Å¶„ÅÑ„Åæ„Åô"
      />

      {/* ËøΩÂä†„Éá„Éº„ÇøË™≠„ÅøËæº„Åø‰∏≠„ÅÆ„É¢„Éº„ÉÄ„É´ */}
      <ProgressModalDynamic
        isVisible={additionalDataLoading}
        progress={additionalDataProgress}
        totalPlans={1}
        onCancel={() => {}} // „Ç≠„É£„É≥„Çª„É´‰∏çÂèØ
        customTitle="Ë©≥Á¥∞ÊÉÖÂ†±„ÇíË™≠„ÅøËæº„Åø‰∏≠..."
        customSubtitle="ÁîªÂÉè„Éª„Éû„ÉÉ„Éó„Éª„Éõ„ÉÜ„É´ÊÉÖÂ†±„ÇíÂèñÂæó„Åó„Å¶„ÅÑ„Åæ„Åô"
      />

      {/* Header */}
      <div className="bg-white shadow-sm">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div className="flex justify-between items-center py-6">
            <div>
              <h1 className="text-2xl font-bold text-gray-900">
                ÊóÖË°å„Éó„É©„É≥ÊèêÊ°à
              </h1>
              <p className="text-gray-600">
                „ÅÇ„Å™„Åü„Å´ÊúÄÈÅ©„Å™3„Å§„ÅÆ„Éó„É©„É≥„Çí„ÅîÁî®ÊÑè„Åó„Åæ„Åó„Åü
              </p>
            </div>
            <div className="flex items-center space-x-4">
              <button
                onClick={handleRegenerate}
                className="bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-lg font-medium transition-colors"
              >
                Êñ∞„Åó„ÅÑ„Éó„É©„É≥„ÇíÁîüÊàê
              </button>
              <UserProfile />
            </div>
          </div>
        </div>
      </div>

      <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        {/* „É¶„Éº„Ç∂„ÉºÂêë„ÅëÊ°àÂÜÖ - Êú™Ë™çË®ºÊôÇ */}
        {!currentUser && (
          <div className="bg-blue-50 border border-blue-200 rounded-xl p-6 mb-6">
            <div className="flex items-start space-x-3">
              <div className="text-2xl">‚ÑπÔ∏è</div>
              <div>
                <h3 className="text-lg font-semibold text-blue-900 mb-2">
                  „Éó„É©„É≥„ÅåÁîüÊàê„Åï„Çå„Åæ„Åó„ÅüÔºÅ
                </h3>
                <p className="text-blue-800 text-sm mb-3">
                  „Éó„É©„É≥„ÅÆÊ¶ÇË¶Å„ÅØ„ÅîË¶ß„ÅÑ„Åü„Å†„Åë„Åæ„Åô„Åå„ÄÅË©≥Á¥∞„Å™ÊÉÖÂ†±Ôºà„Éõ„ÉÜ„É´„ÄÅ„É´„Éº„Éà„ÄÅ„Ç¢„ÇØ„ÉÜ„Ç£„Éì„ÉÜ„Ç£„ÅÆË©≥Á¥∞„Å™„Å©Ôºâ„ÇíË¶ã„Çã„Å´„ÅØ„É≠„Ç∞„Ç§„É≥„ÅåÂøÖË¶Å„Åß„Åô„ÄÇ
                </p>
                <button
                  onClick={() => router.push("/login?redirect=%2Fplans")}
                  className="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-blue-700 transition-colors"
                >
                  „É≠„Ç∞„Ç§„É≥„Åó„Å¶Ë©≥Á¥∞„ÇíË¶ã„Çã
                </button>
              </div>
            </div>
          </div>
        )}

        {/* Plan Selection Cards */}
        <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
          {plans && plans.length > 0 ? (
            plans
              .filter((plan) => plan && plan.hero)
              .map((plan, index) => (
                <div
                  key={plan.trip_id || index}
                  className={`bg-white rounded-2xl shadow-lg overflow-hidden cursor-pointer transform transition-all duration-200 hover:scale-105 ${
                    selectedPlan === index
                      ? "ring-4 ring-blue-500 ring-opacity-50"
                      : "hover:shadow-xl"
                  }`}
                  onClick={() => handlePlanSelect(index)}
                >
                  <div className="relative h-48">
                    <img
                      src={
                        heroImages[plan.trip_id]?.photo_url ||
                        plan.hero?.hero_image ||
                        "https://images.unsplash.com/photo-1476514525535-07fb3b4ae5f1?w=800&h=600&fit=crop"
                      }
                      alt={plan.hero?.title || "„Éó„É©„É≥ÁîªÂÉè"}
                      className="w-full h-full object-cover"
                      onError={(e) => {
                        e.target.src =
                          plan.hero?.hero_image ||
                          "https://images.unsplash.com/photo-1476514525535-07fb3b4ae5f1?w=800&h=600&fit=crop";
                      }}
                    />
                    <div className="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent"></div>
                    <div className="absolute bottom-0 left-0 right-0 p-4">
                      <h3 className="text-xl font-bold text-white mb-1">
                        {plan.hero?.title || "„Éó„É©„É≥ÂêçÊú™Ë®≠ÂÆö"}
                      </h3>
                      <p className="text-gray-200 text-sm">
                        {plan.hero?.subtitle || ""}
                      </p>
                    </div>
                  </div>

                  <div className="p-4">
                    <div className="flex justify-between items-center mb-3">
                      <span className="text-blue-600 font-semibold">
                        {(() => {
                          if (plan.hero?.duration) {
                            return plan.hero.duration;
                          } else if (
                            plan.itinerary &&
                            plan.itinerary.length > 0
                          ) {
                            return `${plan.itinerary.length}Êó•Èñì`;
                          } else {
                            return "ÊúüÈñìÊú™Ë®≠ÂÆö";
                          }
                        })()}
                      </span>
                      <span className="text-purple-600 font-semibold">
                        {plan.hero?.budget || "‰∫àÁÆóÊú™Ë®≠ÂÆö"}
                      </span>
                    </div>

                    <div className="flex flex-wrap gap-2 mb-4">
                      {(plan.hero?.highlights || [])
                        .slice(0, 2)
                        .map((highlight, idx) => (
                          <span
                            key={idx}
                            className="bg-gray-100 text-gray-700 text-xs px-2 py-1 rounded-full"
                          >
                            {highlight}
                          </span>
                        ))}
                      {(plan.hero?.highlights || []).length > 2 && (
                        <span className="bg-gray-100 text-gray-700 text-xs px-2 py-1 rounded-full">
                          +{(plan.hero?.highlights || []).length - 2}
                        </span>
                      )}
                    </div>

                    <div className="flex justify-between items-center">
                      <span className="text-sm text-gray-600">
                        üìç {plan.hero?.destination || "ÁõÆÁöÑÂú∞Êú™Ë®≠ÂÆö"}
                      </span>
                      {selectedPlan === index && (
                        <span className="bg-blue-100 text-blue-700 text-xs px-2 py-1 rounded-full font-medium">
                          ÈÅ∏Êäû‰∏≠
                        </span>
                      )}
                    </div>
                  </div>
                </div>
              ))
          ) : (
            <div className="col-span-3 text-center py-8">
              <p className="text-gray-500">„Éó„É©„É≥„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø‰∏≠...</p>
            </div>
          )}
        </div>

        {/* Selected Plan Details */}
        {selectedPlanData && !isRegenerating && (
          <BlurredContent isAuthenticated={!!currentUser} title="Ë©≥Á¥∞„Å™„Éó„É©„É≥">
            <div className="lg:grid lg:grid-cols-3 lg:gap-8">
              {/* Main Content */}
              <div className="lg:col-span-2">
                {/* Detailed Itinerary */}
                <div className="space-y-8">
                  {selectedPlanData.itinerary.map((day, dayIndex) => (
                    <div
                      key={day.day}
                      className="bg-white rounded-2xl shadow-lg overflow-hidden"
                    >
                      {/* Day Header */}
                      <div className="relative h-32 sm:h-40">
                        <img
                          src={
                            dayImages[selectedPlanData.trip_id]?.[day.day]
                              ?.photo_url || day.city.image
                          }
                          alt={day.city.name}
                          className="w-full h-full object-cover"
                          onError={(e) => {
                            e.target.src = day.city.image; // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ
                          }}
                        />
                        <div className="absolute inset-0 bg-gradient-to-r from-black/60 to-transparent"></div>
                        <div className="absolute bottom-0 left-0 right-0 p-6">
                          <h3 className="text-2xl font-bold text-white">
                            Day {day.day}
                          </h3>
                          <p className="text-lg text-gray-200">
                            {day.city.name} - {day.city.description}
                          </p>
                        </div>
                      </div>

                      {/* Activities */}
                      <div className="p-6">
                        <div className="space-y-6">
                          {day.activities.map((activity, activityIndex) => (
                            <div
                              key={activity.id}
                              className="border border-gray-100 rounded-lg p-4"
                            >
                              <div className="flex flex-col sm:flex-row gap-6">
                                <div className="sm:w-48 flex-shrink-0">
                                  <img
                                    src={
                                      activityImages[
                                        selectedPlanData.trip_id
                                      ]?.[activity.id]?.photo_url ||
                                      activity.image
                                    }
                                    alt={activity.title}
                                    className="w-full h-32 sm:h-36 object-cover rounded-lg"
                                    onError={(e) => {
                                      e.target.src = activity.image; // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ
                                    }}
                                  />
                                </div>

                                <div className="flex-1">
                                  <div className="flex items-start justify-between mb-3">
                                    <div className="flex-1">
                                      <div className="flex items-center space-x-3 mb-2">
                                        <span className="text-blue-600 font-semibold text-lg">
                                          {activity.time}
                                        </span>
                                        <span
                                          className={`px-3 py-1 rounded-full text-sm font-medium ${
                                            activity.priority === "must_see"
                                              ? "bg-red-100 text-red-700"
                                              : activity.priority === "must_do"
                                              ? "bg-orange-100 text-orange-700"
                                              : "bg-green-100 text-green-700"
                                          }`}
                                        >
                                          {activity.priority === "must_see"
                                            ? "ÂøÖË¶ã"
                                            : activity.priority === "must_do"
                                            ? "ÂøÖÈ†à"
                                            : "„Åä„Åô„Åô„ÇÅ"}
                                        </span>
                                      </div>
                                      <h4 className="text-xl font-bold text-gray-900 mb-1">
                                        {activity.title}
                                      </h4>
                                      <p className="text-gray-600 font-medium mb-2">
                                        {activity.subtitle}
                                      </p>
                                    </div>
                                  </div>

                                  <p className="text-gray-700 mb-4 leading-relaxed">
                                    {activity.description}
                                  </p>

                                  <div className="flex flex-wrap items-center gap-4 mb-4">
                                    <div className="flex items-center">
                                      <span className="text-gray-500 mr-1">
                                        üìç
                                      </span>
                                      <span className="text-gray-700">
                                        {activity.location}
                                      </span>
                                    </div>
                                    <div className="flex items-center">
                                      <span className="text-gray-500 mr-1">
                                        üí∞
                                      </span>
                                      <span className="text-gray-700 font-medium">
                                        {activity.price}
                                      </span>
                                    </div>
                                    <div className="flex items-center">
                                      <span className="text-yellow-500 mr-1">
                                        ‚≠ê
                                      </span>
                                      <span className="text-gray-700 font-medium">
                                        {activity.rating}
                                      </span>
                                    </div>
                                  </div>

                                  {activity.tips && (
                                    <div className="bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded-r-lg">
                                      <p className="text-yellow-800">
                                        <span className="font-medium">
                                          üí° Tip:{" "}
                                        </span>
                                        {activity.tips}
                                      </p>
                                    </div>
                                  )}
                                </div>
                              </div>
                            </div>
                          ))}
                        </div>

                        {/* 1Êó•„ÅÆÁµåË∑Ø„Éû„ÉÉ„Éó */}
                        {routeData[selectedPlanData.trip_id]?.[
                          `day_${day.day}`
                        ] ? (
                          <div className="mt-4">
                            <h5 className="font-medium text-gray-900 mb-2 flex items-center">
                              <span className="mr-2">üó∫Ô∏è</span>
                              Day {day.day} „ÅÆÁßªÂãï„É´„Éº„Éà
                            </h5>
                            <InteractiveMap
                              staticMapUrl={
                                routeData[selectedPlanData.trip_id][
                                  `day_${day.day}`
                                ].static_map_url
                              }
                              routeInfo={
                                routeData[selectedPlanData.trip_id][
                                  `day_${day.day}`
                                ]
                              }
                              height="250px"
                            />
                          </div>
                        ) : (
                          <div className="mt-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                            <div className="flex items-center">
                              <span className="text-yellow-600 mr-2">‚ö†Ô∏è</span>
                              <div>
                                <p className="text-yellow-800 font-medium">
                                  Day {day.day} „ÅÆÁµåË∑ØÊÉÖÂ†±„ÇíÂèñÂæó‰∏≠
                                </p>
                                <p className="text-yellow-700 text-sm">
                                  {day.activities.length > 0
                                    ? `${day.activities.length}ÁÆáÊâÄ„ÅÆ„Çπ„Éù„ÉÉ„ÉàÈñì„ÅÆÊúÄÈÅ©„É´„Éº„Éà„ÇíË®àÁÆó„Åó„Å¶„ÅÑ„Åæ„Åô...`
                                    : "„Åì„ÅÆ„Ç®„É™„Ç¢„ÅÆÁßªÂãïÊÉÖÂ†±„ÇíÊ∫ñÂÇô‰∏≠„Åß„Åô..."}
                                </p>
                              </div>
                            </div>
                          </div>
                        )}

                        {/* ÂΩìÊó•„ÅÆÂÆøÊ≥äÂÖà */}
                        {day.accommodation &&
                          day.accommodation !== "Âá∫Áô∫Êó•„ÅÆ„Åü„ÇÅÂÆøÊ≥ä„Å™„Åó" && (
                            <div className="mt-6">
                              <h5 className="font-medium text-gray-900 mb-3 flex items-center">
                                <span className="mr-2">üè®</span>
                                Day {day.day} „ÅÆÂÆøÊ≥äÂÖà
                              </h5>
                              {hotels[selectedPlanData.trip_id]?.[
                                `day_${day.day}`
                              ] &&
                              hotels[selectedPlanData.trip_id][`day_${day.day}`]
                                .length > 0 ? (
                                <div className="space-y-3">
                                  {hotels[selectedPlanData.trip_id][
                                    `day_${day.day}`
                                  ]
                                    .slice(0, 2)
                                    .map((hotel, hotelIndex) => (
                                      <div
                                        key={hotelIndex}
                                        className="bg-blue-50 rounded-lg p-4 border border-blue-200"
                                      >
                                        <div className="flex items-start space-x-3">
                                          <img
                                            src={hotel.image}
                                            alt={hotel.name}
                                            className="w-16 h-16 object-cover rounded-lg flex-shrink-0"
                                          />
                                          <div className="flex-1 min-w-0">
                                            <h6 className="font-semibold text-gray-900 text-sm mb-1">
                                              {hotel.name}
                                            </h6>
                                            <p className="text-xs text-gray-600 mb-2 flex items-center">
                                              <span className="mr-1">üìç</span>
                                              {hotel.location}
                                            </p>
                                            <div className="flex items-center justify-between">
                                              <div className="flex items-center space-x-2">
                                                <div className="flex text-yellow-400 text-xs">
                                                  {[...Array(5)].map((_, i) => (
                                                    <span
                                                      key={i}
                                                      className={
                                                        i <
                                                        Math.floor(hotel.rating)
                                                          ? "text-yellow-400"
                                                          : "text-gray-300"
                                                      }
                                                    >
                                                      ‚≠ê
                                                    </span>
                                                  ))}
                                                </div>
                                                <span className="text-xs text-gray-600">
                                                  {hotel.rating}
                                                </span>
                                              </div>
                                              <div className="text-right">
                                                <div className="text-sm font-semibold text-blue-600">
                                                  {hotel.price}
                                                </div>
                                                <a
                                                  href={hotel.url}
                                                  target="_blank"
                                                  rel="noopener noreferrer"
                                                  className="text-xs text-blue-500 hover:text-blue-700 underline"
                                                >
                                                  Ë©≥Á¥∞„ÇíË¶ã„Çã
                                                </a>
                                              </div>
                                            </div>
                                          </div>
                                        </div>
                                      </div>
                                    ))}
                                  {hotels[selectedPlanData.trip_id][
                                    `day_${day.day}`
                                  ].length > 2 && (
                                    <p className="text-xs text-gray-500 text-center">
                                      ‰ªñ„Å´
                                      {hotels[selectedPlanData.trip_id][
                                        `day_${day.day}`
                                      ].length - 2}
                                      ‰ª∂„ÅÆ„Éõ„ÉÜ„É´„Åå„ÅÇ„Çä„Åæ„Åô
                                    </p>
                                  )}
                                </div>
                              ) : (
                                <div className="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg p-4 border border-blue-200">
                                  <div className="mb-3">
                                    <div className="flex items-center justify-between mb-2">
                                      <div>
                                        <p className="text-sm font-medium text-gray-900">
                                          {day.accommodation}
                                        </p>
                                        <p className="text-xs text-gray-600 mt-1">
                                          ÂÆøÊ≥ä„Ç®„É™„Ç¢
                                        </p>
                                      </div>
                                      <div className="text-right">
                                        <p className="text-sm text-gray-700">
                                          ‰∫àÁÆóÁõÆÂÆâ: ¬•8,000„Äú
                                        </p>
                                      </div>
                                    </div>
                                  </div>
                                  
                                  {/* ÊóÖË°å„ÅÆË±ÜÁü•Ë≠ò */}
                                  <div className="bg-white rounded-lg p-3 border-l-4 border-blue-500">
                                    <div className="flex items-center mb-2">
                                      <span className="text-lg mr-2">üí°</span>
                                      <p className="text-sm font-semibold text-blue-900">
                                        ÊóÖË°å„ÅÆË±ÜÁü•Ë≠ò
                                      </p>
                                    </div>
                                    <p className="text-sm text-gray-700 leading-relaxed">
                                      {(() => {
                                        const tips = [
                                          "Êó•Êú¨„ÅÆÊ∏©Ê≥â„Å´ÂÖ•„ÇãÂâç„ÅØÂøÖ„Åö„Åã„ÅëÊπØ„Çí„Åó„Å¶‰Ωì„ÇíÊ∏Ö„ÇÅ„Åæ„Åó„Çá„ÅÜ„ÄÇÂøÉË∫´„Å®„ÇÇ„Å´„É™„Éï„É¨„ÉÉ„Ç∑„É•„Åß„Åç„Åæ„Åô„ÄÇ",
                                          "Âú∞ÂÖÉ„ÅÆÈÉ∑ÂúüÊñôÁêÜ„ÇíÂë≥„Çè„ÅÜ„Åì„Å®„Åß„ÄÅ„Åù„ÅÆÂúüÂú∞„ÅÆÊñáÂåñ„Å®Ê≠¥Âè≤„ÇíÊÑü„Åò„Çã„Åì„Å®„Åå„Åß„Åç„Åæ„Åô„ÄÇ",
                                          "Á•ûÁ§æÂèÇÊãù„Åß„ÅØ„ÄÅÂèÇÈÅì„ÅÆ‰∏≠Â§Æ„ÅØÁ•ûÊßò„ÅÆÈÄö„ÇäÈÅì„Å™„ÅÆ„ÅßÁ´Ø„ÇíÊ≠©„Åè„ÅÆ„Åå„Éû„Éä„Éº„Åß„Åô„ÄÇ",
                                          "ÊóÖÂÖà„Åß„ÅÆÂá∫‰ºö„ÅÑ„ÇíÂ§ßÂàá„Å´„ÄÇÂú∞ÂÖÉ„ÅÆÊñπ„Å®„ÅÆ‰ºöË©±„Åã„ÇâÊñ∞„Åó„ÅÑÁô∫Ë¶ã„Åå„ÅÇ„Çã„Åì„Å®„ÇÇ„ÄÇ",
                                          "Â≠£ÁØÄ„Åî„Å®„ÅÆÈ¢®ÊôØ„ÇíÊ•Ω„Åó„Åø„Åæ„Åó„Çá„ÅÜ„ÄÇÊó•Êú¨„ÅÆÂõõÂ≠£„ÅØ„Åù„Çå„Åû„ÇåÁâπÂà•„Å™Áæé„Åó„Åï„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ"
                                        ];
                                        const randomTip = tips[Math.floor(Math.random() * tips.length)];
                                        return randomTip;
                                      })()}
                                    </p>
                                  </div>
                                </div>
                              )}
                            </div>
                          )}
                      </div>
                    </div>
                  ))}

                  {/* Interactive Route Map */}
                  {routeData[selectedPlanData.trip_id]?.overall && (
                    <div className="mt-8">
                      <h3 className="text-xl font-semibold text-gray-900 mb-4">
                        ÂÖ®‰ΩìÊóÖË°å„É´„Éº„Éà
                      </h3>
                      <div className="bg-white rounded-xl shadow-md p-6">
                        <InteractiveMap
                          staticMapUrl={
                            routeData[selectedPlanData.trip_id].overall
                              .static_map_url
                          }
                          routeInfo={
                            routeData[selectedPlanData.trip_id].overall.route
                          }
                          height="300px"
                        />
                      </div>
                    </div>
                  )}

                  {/* Recommended Hotels */}
                  <div className="mt-8">
                    <h3 className="text-xl font-semibold text-gray-900 mb-4">
                      „Åä„Åô„Åô„ÇÅ„Éõ„ÉÜ„É´
                    </h3>
                    {hotels[selectedPlanData.trip_id] &&
                    Object.keys(hotels[selectedPlanData.trip_id]).length > 0 ? (
                      <div className="space-y-6">
                        {Object.entries(hotels[selectedPlanData.trip_id]).map(
                          ([dayKey, dayHotels]) => {
                            const dayNumber = dayKey.replace("day_", "");
                            const dayData = selectedPlanData.itinerary.find(
                              (d) => d.day === parseInt(dayNumber)
                            );

                            if (!dayHotels || dayHotels.length === 0)
                              return null;

                            return (
                              <div
                                key={dayKey}
                                className="bg-gray-50 rounded-xl p-4"
                              >
                                <h4 className="text-lg font-semibold text-gray-900 mb-3 flex items-center">
                                  <span className="mr-2">üè®</span>
                                  Day {dayNumber} ({dayData?.accommodation})
                                  „ÅÆ„Éõ„ÉÜ„É´
                                </h4>
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                  {dayHotels.slice(0, 6).map((hotel, index) => (
                                    <div
                                      key={`${dayKey}-${index}`}
                                      className="bg-white rounded-xl shadow-md overflow-hidden hover:shadow-lg transition-shadow duration-300"
                                    >
                                      <div className="relative">
                                        <img
                                          src={hotel.image}
                                          alt={hotel.name}
                                          className="w-full h-32 object-cover"
                                        />
                                        <div className="absolute top-2 right-2 bg-black bg-opacity-50 text-white px-2 py-1 rounded text-xs">
                                          Day {dayNumber}
                                        </div>
                                      </div>
                                      <div className="p-4">
                                        <h5 className="font-bold text-gray-900 mb-2 text-sm leading-tight">
                                          {hotel.name}
                                        </h5>
                                        <p className="text-xs text-gray-600 mb-2 flex items-center">
                                          <span className="mr-1">üìç</span>
                                          {hotel.location}
                                        </p>
                                        <div className="flex items-center justify-between mb-2">
                                          <div className="flex items-center space-x-1">
                                            <div className="flex text-yellow-400 text-xs">
                                              {[...Array(5)].map((_, i) => (
                                                <span
                                                  key={i}
                                                  className={
                                                    i < Math.floor(hotel.rating)
                                                      ? "text-yellow-400"
                                                      : "text-gray-300"
                                                  }
                                                >
                                                  ‚≠ê
                                                </span>
                                              ))}
                                            </div>
                                            <span className="text-xs text-gray-600">
                                              {hotel.rating} (
                                              {hotel.reviewCount}‰ª∂)
                                            </span>
                                          </div>
                                        </div>
                                        <div className="flex items-center justify-between">
                                          <span className="text-sm font-bold text-blue-600">
                                            {hotel.price}
                                          </span>
                                          <a
                                            href={hotel.url}
                                            target="_blank"
                                            rel="noopener noreferrer"
                                            className="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-xs font-medium transition-colors duration-200"
                                          >
                                            Ë©≥Á¥∞
                                          </a>
                                        </div>
                                      </div>
                                    </div>
                                  ))}
                                </div>
                                {/* {dayHotels.length > 6 && (
                                  <p className="text-sm text-gray-500 text-center mt-3">
                                    ‰ªñ„Å´{dayHotels.length - 6}
                                    ‰ª∂„ÅÆ„Éõ„ÉÜ„É´„Åå„ÅÇ„Çä„Åæ„Åô
                                  </p>
                                )} */}
                              </div>
                            );
                          }
                        )}
                      </div>
                    ) : (
                      <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                        <div className="flex items-center">
                          <span className="text-yellow-600 mr-2">‚ö†Ô∏è</span>
                          <p className="text-yellow-800">
                            „Åì„ÅÆÂú∞Âüü„ÅÆ„Éõ„ÉÜ„É´ÊÉÖÂ†±„ÇíÂèñÂæó‰∏≠„Åß„Åô„ÄÇ„Åó„Å∞„Çâ„Åè„ÅäÂæÖ„Å°„Åè„Å†„Åï„ÅÑ„ÄÇ
                          </p>
                        </div>
                      </div>
                    )}
                  </div>

                  {/* Location Information */}
                  {/* {locationData[selectedPlanData.hero.title] && (
                    <div className="mt-8">
                      <h3 className="text-xl font-semibold text-gray-900 mb-4">
                        „Ç®„É™„Ç¢ÊÉÖÂ†±
                      </h3>
                      <div className="bg-white rounded-xl shadow-md p-6">
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                          {locationData[selectedPlanData.hero.title]
                            .map_image_url && (
                            <div className="space-y-2">
                              <h4 className="font-semibold text-gray-900 mb-3 flex items-center">
                                <span className="mr-2">üó∫Ô∏è</span>
                                ‰ΩçÁΩÆÊÉÖÂ†±
                              </h4>
                              <div className="relative group">
                                <img
                                  src={
                                    locationData[selectedPlanData.hero.title]
                                      .map_image_url
                                  }
                                  alt={`${selectedPlanData.hero.title}„ÅÆÂú∞Âõ≥`}
                                  className="w-full h-48 object-cover rounded-lg cursor-pointer group-hover:opacity-90 transition-opacity"
                                />
                                <div className="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity bg-black bg-opacity-30 rounded-lg">
                                  <span className="text-white font-medium">
                                    Google Maps„ÅßÈñã„Åè
                                  </span>
                                </div>
                                <a
                                  href={`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(
                                    selectedPlanData.hero.title
                                  )}`}
                                  target="_blank"
                                  rel="noopener noreferrer"
                                  className="absolute inset-0"
                                >
                                  <span className="sr-only">
                                    Google Maps„Åß{selectedPlanData.hero.title}
                                    „ÇíÈñã„Åè
                                  </span>
                                </a>
                              </div>
                            </div>
                          )}
                          {locationData[selectedPlanData.hero.title]
                            .photo_url && (
                            <div className="space-y-2">
                              <h4 className="font-semibold text-gray-900 mb-3 flex items-center">
                                <span className="mr-2">üì∏</span>
                                ÁèæÂú∞„ÅÆÈ¢®ÊôØ
                              </h4>
                              <img
                                src={
                                  locationData[selectedPlanData.hero.title]
                                    .photo_url
                                }
                                alt={selectedPlanData.hero.title}
                                className="w-full h-48 object-cover rounded-lg shadow-sm"
                              />
                            </div>
                          )}
                        </div>
                        <div className="mt-6 pt-4 border-t border-gray-200">
                          <div className="flex items-start space-x-2">
                            <span className="text-blue-600 mt-0.5">üìç</span>
                            <div>
                              <p className="text-sm font-medium text-gray-900">
                                ‰ΩèÊâÄ
                              </p>
                              <p className="text-sm text-gray-600">
                                {
                                  locationData[selectedPlanData.hero.title]
                                    .formatted_address
                                }
                              </p>
                            </div>
                          </div>
                          {locationData[selectedPlanData.hero.title]
                            .coordinates && (
                            <div className="flex items-start space-x-2 mt-3">
                              <span className="text-green-600 mt-0.5">üåê</span>
                              <div>
                                <p className="text-sm font-medium text-gray-900">
                                  Â∫ßÊ®ô
                                </p>
                                <p className="text-sm text-gray-600">
                                  {locationData[
                                    selectedPlanData.hero.title
                                  ].coordinates.lat.toFixed(6)}
                                  ,{" "}
                                  {locationData[
                                    selectedPlanData.hero.title
                                  ].coordinates.lng.toFixed(6)}
                                </p>
                              </div>
                            </div>
                          )}
                        </div>
                      </div>
                    </div>
                  )} */}
                </div>
              </div>

              {/* Sidebar */}
              <div className="lg:col-span-1 mt-8 lg:mt-0">
                <div className="sticky top-8 space-y-6">
                  {/* Plan Summary */}
                  <div className="bg-white rounded-2xl shadow-lg p-6">
                    <h3 className="text-lg font-semibold text-gray-900 mb-4">
                      üìã „Éó„É©„É≥Ê¶ÇË¶Å
                    </h3>
                    {!startDate && !endDate && (
                      <div className="mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                        <p className="text-sm text-blue-700">
                          üí° Êó•Á®ãÊú™Ë®≠ÂÆö„Åß„ÇÇ„ÄÅAI„ÅåÊúÄÈÅ©„Å™
                          {selectedPlanData.itinerary
                            ? selectedPlanData.itinerary.length
                            : 0}
                          Êó•Èñì„ÅÆ„Éó„É©„É≥„Çí‰ΩúÊàê„Åó„Åæ„Åó„Åü
                        </p>
                      </div>
                    )}
                    <div className="space-y-3">
                      <div className="flex justify-between">
                        <span className="text-gray-600">ÊúüÈñì</span>
                        {startDate && endDate ? (
                          <div className="text-right">
                            <div className="font-medium text-blue-600">
                              {new Date(startDate).toLocaleDateString("ja-JP", {
                                month: "short",
                                day: "numeric",
                              })}{" "}
                              „Äú{" "}
                              {new Date(endDate).toLocaleDateString("ja-JP", {
                                month: "short",
                                day: "numeric",
                              })}
                            </div>
                            <div className="text-xs text-gray-500">
                              {(() => {
                                const start = new Date(startDate);
                                const end = new Date(endDate);
                                const days =
                                  Math.ceil(
                                    (end - start) / (1000 * 60 * 60 * 24)
                                  ) + 1;
                                return `${days}Êó•Èñì„ÅÆÊóÖÁ®ã`;
                              })()}
                            </div>
                          </div>
                        ) : (
                          <div className="text-right">
                            <div className="font-medium text-gray-700">
                              {selectedPlanData.hero.duration}
                            </div>
                            <div className="text-xs text-gray-500">
                              {(() => {
                                // itinerary„ÅÆÊó•Êï∞„Åã„ÇâÂÆüÈöõ„ÅÆÊóÖË°åÊó•Êï∞„ÇíË°®Á§∫
                                const actualDays = selectedPlanData.itinerary
                                  ? selectedPlanData.itinerary.length
                                  : 0;
                                return actualDays > 0
                                  ? `${actualDays}Êó•Èñì„ÅÆ„Éó„É©„É≥`
                                  : "Êó•Á®ãÊú™Ë®≠ÂÆö";
                              })()}
                            </div>
                          </div>
                        )}
                      </div>
                      <div className="flex justify-between">
                        <span className="text-gray-600">‰∫àÁÆóÁõÆÂÆâ</span>
                        <span className="font-medium">
                          {selectedPlanData.hero.budget}
                        </span>
                      </div>
                      {startDate && endDate && (
                        <div className="flex justify-between">
                          <span className="text-gray-600">ÊóÖË°åÊó•Á®ã</span>
                          <span className="font-medium text-blue-600">
                            {startDate} „Äú {endDate}
                          </span>
                        </div>
                      )}
                    </div>

                    {/* Êó•Á®ãÈÅ∏Êäû„Éï„Ç©„Éº„É† */}
                    {showDatePicker && (
                      <div className="mt-4 p-4 bg-gray-50 rounded-lg">
                        <h4 className="font-medium text-gray-900 mb-3">
                          ÊóÖË°åÊó•Á®ã„ÇíÈÅ∏Êäû
                        </h4>
                        <div className="space-y-3">
                          <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">
                              Âá∫Áô∫Êó•
                            </label>
                            <input
                              type="date"
                              value={startDate}
                              onChange={(e) => setStartDate(e.target.value)}
                              min={new Date().toISOString().split("T")[0]}
                              className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            />
                          </div>
                          <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">
                              Â∏∞ÁùÄÊó•
                            </label>
                            <input
                              type="date"
                              value={endDate}
                              onChange={(e) => setEndDate(e.target.value)}
                              min={
                                startDate ||
                                new Date().toISOString().split("T")[0]
                              }
                              className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            />
                          </div>
                          <div className="flex space-x-2">
                            <button
                              onClick={handleDateConfirm}
                              className="flex-1 bg-blue-600 text-white py-2 rounded-lg text-sm font-medium hover:bg-blue-700 transition-colors"
                            >
                              Á¢∫ÂÆö
                            </button>
                            <button
                              onClick={() => setShowDatePicker(false)}
                              className="flex-1 bg-gray-300 text-gray-700 py-2 rounded-lg text-sm font-medium hover:bg-gray-400 transition-colors"
                            >
                              „Ç≠„É£„É≥„Çª„É´
                            </button>
                          </div>
                        </div>
                      </div>
                    )}

                    <button
                      onClick={handleConfirmPlan}
                      className="w-full mt-6 bg-gradient-to-r from-blue-600 to-indigo-700 text-white py-3 rounded-lg font-semibold hover:shadow-lg transform hover:scale-105 transition-all duration-200 flex items-center justify-center"
                    >
                      <span>„Éó„É©„É≥„ÇíÁ¢∫ÂÆö„Åô„Çã</span>
                      <svg
                        className="w-5 h-5 ml-2"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          strokeLinecap="round"
                          strokeLinejoin="round"
                          strokeWidth={2}
                          d="M5 13l4 4L19 7"
                        />
                      </svg>
                    </button>
                  </div>

                  {/* „Éó„É©„É≥„Ç´„Çπ„Çø„Éû„Ç§„Ç∫ */}
                  <div className="bg-white rounded-2xl shadow-lg p-6">
                    <h3 className="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                      <span className="mr-2">‚ú®</span>
                      „Éó„É©„É≥„Çí„Ç´„Çπ„Çø„Éû„Ç§„Ç∫
                    </h3>
                    <p className="text-gray-600 mb-6">
                      ÁèæÂú®„ÅÆ„Éó„É©„É≥„Çí„Éô„Éº„Çπ„Å´„ÄÅ„ÅÇ„Å™„Åü„ÅÆËøΩÂä†„ÅÆË¶ÅÊúõ„ÇíÂèçÊò†„Åó„ÅüÊñ∞„Åó„ÅÑ„Éó„É©„É≥„ÇíÁîüÊàê„Åß„Åç„Åæ„Åô„ÄÇ
                    </p>

                    {!showRegenerateForm ? (
                      <button
                        onClick={() => setShowRegenerateForm(true)}
                        className="w-full bg-gradient-to-r from-purple-600 to-indigo-700 text-white px-6 py-3 rounded-lg font-semibold hover:shadow-lg transform hover:scale-105 transition-all duration-200 flex items-center justify-center"
                      >
                        <span className="mr-2">üéØ</span>
                        „Éó„É©„É≥„Çí„Ç´„Çπ„Çø„Éû„Ç§„Ç∫„Åô„Çã
                      </button>
                    ) : (
                      <div className="space-y-4">
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-2">
                            ËøΩÂä†„ÅÆË¶ÅÊúõ„ÇÑ„É™„ÇØ„Ç®„Çπ„Éà
                          </label>
                          <textarea
                            value={additionalPrompt}
                            onChange={(e) => setAdditionalPrompt(e.target.value)}
                            className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent resize-none"
                            rows="4"
                            placeholder="‰æã: „ÇÇ„Å£„Å®Ëá™ÁÑ∂„ÇíÊ•Ω„Åó„ÇÅ„Çã„Çπ„Éù„ÉÉ„Éà„ÇíËøΩÂä†„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÅ‰∫àÁÆó„ÇíÊäë„Åà„Åü„ÅÑ„ÄÅÂ≠ê‰æõÂêë„Åë„ÅÆÊñΩË®≠„ÇíÂê´„ÇÅ„Å¶„Åè„Å†„Åï„ÅÑ„ÄÅ„Å™„Å©"
                          />
                        </div>
                        <div className="flex space-x-3">
                          <button
                            onClick={handleRegenerateWithPrompt}
                            disabled={!additionalPrompt.trim()}
                            className="flex-1 bg-purple-600 text-white px-6 py-2 rounded-lg font-medium hover:bg-purple-700 transition-colors disabled:bg-gray-300 disabled:cursor-not-allowed flex items-center justify-center"
                          >
                            <span className="mr-2">üöÄ</span>
                            Êñ∞„Åó„ÅÑ„Éó„É©„É≥„ÇíÁîüÊàê
                          </button>
                          <button
                            onClick={() => {
                              setShowRegenerateForm(false);
                              setAdditionalPrompt("");
                            }}
                            className="flex-1 bg-gray-300 text-gray-700 px-6 py-2 rounded-lg font-medium hover:bg-gray-400 transition-colors"
                          >
                            „Ç≠„É£„É≥„Çª„É´
                          </button>
                        </div>
                      </div>
                    )}
                  </div>

                  {/* „Éó„É©„É≥ÂÖ±Êúâ */}
                  <div className="bg-white rounded-2xl shadow-lg p-6">
                    <h3 className="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                      <span className="mr-2">üîó</span>
                      „Éó„É©„É≥„ÇíÂÖ±Êúâ
                    </h3>
                    <p className="text-gray-600 mb-6">
                      „Åì„ÅÆ„Éó„É©„É≥„ÇíÂÆ∂Êóè„ÇÑÂèã‰∫∫„Å®ÂÖ±Êúâ„Åó„Å¶„ÄÅ‰∏ÄÁ∑í„Å´ÊóÖË°å„ÅÆË®àÁîª„ÇíÁ´ã„Å¶„Åæ„Åó„Çá„ÅÜ„ÄÇ
                    </p>
                    
                    <div className="relative">
                      <button
                        onClick={handleCopyShareLink}
                        className="w-full bg-gradient-to-r from-green-600 to-teal-700 text-white py-3 rounded-lg font-semibold hover:shadow-lg transform hover:scale-105 transition-all duration-200 flex items-center justify-center"
                      >
                        <svg
                          className="w-5 h-5 mr-2"
                          fill="none"
                          stroke="currentColor"
                          viewBox="0 0 24 24"
                        >
                          <path
                            strokeLinecap="round"
                            strokeLinejoin="round"
                            strokeWidth={2}
                            d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.367 2.684 3 3 0 00-5.367-2.684z"
                          />
                        </svg>
                        <span>ÂÖ±Êúâ„É™„É≥„ÇØ„Çí„Ç≥„Éî„Éº</span>
                      </button>
                      {showCopySuccess && (
                        <div className="absolute top-full left-1/2 transform -translate-x-1/2 mt-2 px-3 py-1 bg-green-600 text-white text-sm rounded-lg whitespace-nowrap z-50">
                          „É™„É≥„ÇØ„Çí„Ç≥„Éî„Éº„Åó„Åæ„Åó„ÅüÔºÅ
                        </div>
                      )}
                    </div>
                  </div>

                  {/* Cost Breakdown */}
                  {/* <CostBreakdown 
                  plan={selectedPlanData}
                  routeData={routeData[selectedPlanData.trip_id]}
                  hotels={hotels[selectedPlanData.trip_id]}
                /> */}
                </div>
              </div>
            </div>
          </BlurredContent>
        )}

        {/* Empty State */}
        {selectedPlan === null && !isRegenerating && (
          <div className="text-center py-12">
            <div className="text-6xl mb-4">üó∫Ô∏è</div>
            <h3 className="text-xl font-semibold text-gray-900 mb-2">
              „Éó„É©„É≥„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ
            </h3>
            <p className="text-gray-600">
              ‰∏äË®ò„ÅÆ„Ç´„Éº„Éâ„Åã„ÇâÊ∞ó„Å´ÂÖ•„Å£„Åü„Éó„É©„É≥„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶Ë©≥Á¥∞„Çí„ÅîË¶ß„Åè„Å†„Åï„ÅÑ
            </p>
          </div>
        )}
      </div>
    </div>
  );
}

// ÁîªÂÉèÂèñÂæó„ÅÆÈñ¢Êï∞„Çí‰øÆÊ≠£„Åó„Å¶„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ„ÇíÊîπÂñÑ
const fetchActivityImages = async (tripId, planData) => {
  try {
    const imagePromises = [];

    for (const day of planData.itinerary) {
      for (const activity of day.activities) {
        const imagePromise = fetch("/api/search-images", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            query:
              activity.image_search_term ||
              `${activity.title} ${day.city?.name || ""}`,
            type: "activity",
          }),
        })
          .then((res) => (res.ok ? res.json() : null))
          .then((data) => ({
            activityId: activity.id,
            imageUrl:
              data?.imageUrl ||
              `https://images.unsplash.com/photo-1551632811-561732d1e306?w=800&h=600&fit=crop&crop=center`, // „Éá„Éï„Ç©„É´„ÉàÁîªÂÉè
          }))
          .catch(() => ({
            activityId: activity.id,
            imageUrl: `https://images.unsplash.com/photo-1551632811-561732d1e306?w=800&h=600&fit=crop&crop=center`, // „Ç®„É©„ÉºÊôÇ„ÅÆ„Éá„Éï„Ç©„É´„ÉàÁîªÂÉè
          }));

        imagePromises.push(imagePromise);
      }
    }

    const imageResults = await Promise.all(imagePromises);
    const imageMap = {};

    imageResults.forEach((result) => {
      if (result.activityId) {
        imageMap[result.activityId] = result.imageUrl;
      }
    });

    setActivityImages((prev) => ({
      ...prev,
      [tripId]: imageMap,
    }));
  } catch (error) {
    console.error("„Ç¢„ÇØ„ÉÜ„Ç£„Éì„ÉÜ„Ç£ÁîªÂÉèÂèñÂæó„Ç®„É©„Éº:", error);
  }
};

const fetchHeroImages = async (tripId, planData) => {
  try {
    const response = await fetch("/api/search-images", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        query: `${planData.hero?.destination || ""} travel landscape`,
        type: "hero",
      }),
    });

    let imageUrl = `https://images.unsplash.com/photo-1469474968028-56623f02e42e?w=1200&h=600&fit=crop&crop=center`; // „Éá„Éï„Ç©„É´„ÉàÁîªÂÉè

    if (response.ok) {
      const data = await response.json();
      if (data?.imageUrl) {
        imageUrl = data.imageUrl;
      }
    }

    setHeroImages((prev) => ({
      ...prev,
      [tripId]: imageUrl,
    }));
  } catch (error) {
    console.error("„Éí„Éº„É≠„ÉºÁîªÂÉèÂèñÂæó„Ç®„É©„Éº:", error);
    // „Ç®„É©„ÉºÊôÇ„ÇÇ„Éá„Éï„Ç©„É´„ÉàÁîªÂÉè„ÇíË®≠ÂÆö
    setHeroImages((prev) => ({
      ...prev,
      [tripId]: `https://images.unsplash.com/photo-1469474968028-56623f02e42e?w=1200&h=600&fit=crop&crop=center`,
    }));
  }
};

// fetchDayImagesÈñ¢Êï∞„ÅÆ‰øÆÊ≠£
const fetchDayImages = async (tripId, planData) => {
  try {
    const imagePromises = planData.itinerary.map(async (day) => {
      try {
        const response = await fetch("/api/search-images", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            query: `${
              day.city?.name || planData.hero?.destination || ""
            } cityscape`,
            type: "city",
          }),
        });

        let imageUrl = `https://images.unsplash.com/photo-1477959858617-67f85cf4f1df?w=800&h=600&fit=crop&crop=center`; // „Éá„Éï„Ç©„É´„ÉàÁîªÂÉè

        if (response.ok) {
          const data = await response.json();
          if (data?.imageUrl) {
            imageUrl = data.imageUrl;
          }
        }

        return {
          day: day.day,
          imageUrl: imageUrl,
        };
      } catch {
        return {
          day: day.day,
          imageUrl: `https://images.unsplash.com/photo-1477959858617-67f85cf4f1df?w=800&h=600&fit=crop&crop=center`,
        };
      }
    });

    const imageResults = await Promise.all(imagePromises);
    const imageMap = {};

    imageResults.forEach((result) => {
      // ‰øÆÊ≠£: dayÁï™Âè∑„ÅßÁõ¥Êé•‰øùÂ≠ò
      imageMap[result.day] = {
        photo_url: result.imageUrl,
      };
    });

    setDayImages((prev) => ({
      ...prev,
      [tripId]: imageMap,
    }));
  } catch (error) {
    console.error("Êó•Âà•ÁîªÂÉèÂèñÂæó„Ç®„É©„Éº:", error);
  }
};
